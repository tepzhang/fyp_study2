---
title: "fyp_study2"
author: "Jinxiao Zhang"
date: "January 25, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load library}
library(gridExtra)
library("kableExtra") # for making nice tables
library(tidyverse)
```

```{r participant list}
# (server must be mounted with appropriate file path)
bp_path <- "Z:/SBER/SBER1_physio_R56/data/Full_Study/byparticipant_data"
(bp_files <- list.files(bp_path))

# for FYP purpose
# authenticate
gs_auth()
gs_ls()
# import from Google Sheet
ss = gs_title("Study Quality Control: Data Checking")
gs_data_check <- gs_read(ss, ws = 2, range = cell_rows(3:107))
pids <- gs_data_check$`Participant ID`
```

```{r import raw task data}
# create the list of csv files of ER task
ercsvs <- character(0)
list_noS2 <- c() # list of participants who had no S2 .csv files
for(pid in pids){
  # create list of session 2 csvs
  s2path <- sprintf("%s/%s/session2", bp_path, pid)
  s2ls <- list.files(s2path, recursive = T, full.names = T)
  fn <- s2ls[c(grep("InstructedER_[0-9]{4}.*csv$", s2ls), 
               #grep("Instructed_ER_Task.*csv$", s2ls), 
               grep("Instructed_ER.*csv$", s2ls))]
  if(length(fn) > 0){
    #print(c(pid, length(fn)))
    ercsvs <- append(ercsvs, fn)
  }else{
    list_noS2 = append(list_noS2, pid)
  }
}
# sort the No_session2 list
list_noS2 <- sort(list_noS2)
# check the files in the No_session2 list
for(pid in list_noS2){
  # create list of session 2 csvs
  s2path <- sprintf("%s/%s/session2", bp_path, pid)
  s2ls <- list.files(s2path, recursive = T, full.names = T)
  # print the ID and the number of files in the "session2" folder
  print(c(pid,length(s2ls)))
}
# 1275 - copy (2 identical files) --> remove the copy
# 1574 - pt1, pt2 (2 files both only had 38 rows)
# 5767 - 2 files created at different time
# 1754 - 2 files created at different time
# 1016 - V1, V2, V3 (V1 and V2 are empty files though)
# 1023 - files in a subfolder "Random Files and test data" --> remove the files in the subfolder
# 3538 - 2 files created at different time

# remove the wrong files
ercsvs <- ercsvs[c(-grep("copy", ercsvs), # contain "copy"
                   -grep("Random Files", ercsvs))] # in the "Random Files" folder




#import the raw data
agg_df_raw <- mutate_all(read.csv(ercsvs[1]), as.character) #aggregated raw data
for(i in 2:length(ercsvs)){
  # aggregate all csvs into 1 dataframe
  agg_df_raw <- bind_rows(agg_df_raw, mutate_all(read.csv(ercsvs[i]), as.character))
}

```

```{r fatigue and focus in task}

########## check the fatigue/quality rating in task #########

#get the block-wise rating data
fatigue_quality_rating <- agg_df_raw %>% 
  group_by(participant) %>% 
  filter(imageFile == "") %>% 
  select(participant, 
         Fatigue.response, 
         Data_Quality.response, 
         Watch_Quality.response,
         Distract_Quality.response,
         Reappraise_Quality.response) %>% 
  filter(row_number()!= 1) %>% # remove the trial before the first block
  mutate(fatigue = as.numeric(Fatigue.response),
         focus = as.numeric(Data_Quality.response),
         watch_quality = as.numeric(Watch_Quality.response),
         distract_quality = as.numeric(Distract_Quality.response),
         reappraise_quality = as.numeric(Reappraise_Quality.response),
         block = row_number()) %>% 
  filter(block <= 5)

# plot of ratings by block
# fatigue
p_fatigue <- ggplot(fatigue_quality_rating, aes(fatigue))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "fatigue rating by block")
p_focus <- ggplot(fatigue_quality_rating, aes(focus))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "focus rating by block")
p_watch <- ggplot(fatigue_quality_rating, aes(watch_quality))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "watch rating by block")
p_distract <- ggplot(fatigue_quality_rating, aes(distract_quality))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "distract rating by block")
p_reappraise <- ggplot(fatigue_quality_rating, aes(reappraise_quality))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "reappraise rating by block")

grid.arrange(p_fatigue, 
             p_focus, 
             p_watch,
             p_distract,
             p_reappraise,
             ncol=1)

# summarize each participant block ratings
fatigue_quality_summary <- fatigue_quality_rating %>% 
  group_by(participant) %>% 
  summarise(fatigue = mean(fatigue, na.rm = T),
            focus = mean(focus, na.rm = T),
            watch_quality = mean(watch_quality, na.rm = T),
            distract_quality = mean(distract_quality, na.rm = T),
            reappraise_quality = mean(reappraise_quality, na.rm = T),
            n = n()) %>% 
  gather(rating_type, score, fatigue:reappraise_quality)

# add levels of rating types
fatigue_quality_summary$rating_type <- factor(fatigue_quality_summary$rating_type,
                                              levels = c("fatigue",
                                                         "focus",
                                                         "watch_quality",
                                                         "distract_quality",
                                                         "reappraise_quality"))

# plot the distribution
ggplot(fatigue_quality_summary, aes(x = score))+
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="red") +
  facet_wrap(.~rating_type, ncol = 3)

ggplot(fatigue_quality_summary, aes(x = score))+
  geom_histogram(aes(), colour="black", fill="white")+
  facet_wrap(.~rating_type, ncol = 3)


```

```{r PSG data processing}
#report path: Z:\SBER\SBER1_physio_R56\SBER_sleepreports_LindaClete\Scored\11.13.18\ScoredPsgs_Reports\09.27.18
#hynogram export path: Z:\SBER\SBER1_physio_R56\data\brux_scored\raw_exports

# the path of raw PSG data
psg_path = "Z:/SBER/SBER1_physio_R56/data/brux_scored/raw_exports"
# list and select the hypnogram data files
psg_files <- list.files(psg_path, full.names = T)
psg_txt_files <- psg_files[grep("hypno.TXT$", psg_files)]
# get the participant numbers
psg_pids <-  str_sub(psg_txt_files, 
                     str_length(psg_txt_files)-13, 
                     str_length(psg_txt_files)-10)


##### read files and calculate the sleep staging information ######
# the raw psg data fram
df.psg <- data.frame()
# the data frame of psg summary report
df.psg_summary <-  data.frame()

for (j in 1:length(psg_pids)){
  # read a single psg file
  psg <- read.csv(psg_txt_files[j]) %>% 
  rename("stage" = "X.") %>% 
  mutate(pid = psg_pids[j],
    time = row_number()/2) %>% # t - time in minute
    select(pid, stage, time)
  # combine the single psg file to the whole data frame
  df.psg = rbind(df.psg, psg)
  
  
  
  
  ####### calculate the PSG report for each participant #######
  # time point of lights out
  time_light_out = 1
  for (i in 1:nrow(psg)){
    if (psg$stage[i] != "?"){
      time_light_out = i/2 
      break
    } 
  }
  # time point of sleep onset
  time_slp_onset = 1
  for (i in (time_light_out*2):nrow(psg)){
    if (psg$stage[i] %in% c("N1", "N2", "N3")){
      time_slp_onset = i/2 
      break
    } 
  }
  # time point of REM onset
  time_rem_onset = 1
  for (i in (time_slp_onset*2):nrow(psg)){
    if(psg$stage[i] == "R"){
      time_rem_onset = i/2 
      break
    }
  }
  # time point of lights on
  time_light_on = 1
  for (i in 1:nrow(psg)){
    if (psg$stage[nrow(psg) +1 - i] != "?"){
      time_light_on = (nrow(psg) +2 - i)/2 
      break
    } 
  }
  # time point of sleep offset
  time_slp_offset = 1
  for (i in (nrow(psg) - time_light_on*2):nrow(psg)){
    if (psg$stage[nrow(psg) +1 - i] %in% c("N1", "N2", "N3", "R")){
      time_slp_offset = (nrow(psg) +2 - i)/2 
      break
    } 
  }
  # total recording time
  psg_trt = nrow(psg)/2
  # time in bed (time available for sleep)
  psg_tib = time_light_on - time_light_out
  # total sleep time
  psg_tst = psg %>% filter(stage %in% c("N1", "N2", "N3", "R")) %>% nrow()/2
  # WASO - wake after sleep onset
  psg_waso = psg %>% 
    filter(time >= time_slp_onset, time < time_light_on) %>% 
    filter(stage == "W") %>% 
    nrow()/2
  # sleep efficiency
  psg_slp_eff = psg_tst/psg_tib
  # sleep onset latency
  psg_slp_latency = time_slp_onset - time_light_out
  # REM latency
  psg_rem_latency = time_rem_onset - time_slp_onset
  # during the sleep period
  psg_sleep <- psg %>% 
    filter(time >= time_slp_onset, time < time_slp_offset) %>% 
    group_by(stage) %>% 
    summarise(duration = n()/2) %>% 
    spread(stage, duration)
  # wake during sleep period
  psg_wake = psg_sleep$W[1]
  # N1 sleep
  psg_n1 = psg_sleep$N1[1]
  psg_n1_perc = psg_n1/psg_tst
  # N2 sleep
  psg_n2 = psg_sleep$N2[1] 
  psg_n2_perc = psg_n2/psg_tst
  # N3 sleep
  psg_n3 = psg_sleep$N3[1]
  psg_n3_perc = psg_n3/psg_tst
  # REM sleep
  psg_rem = psg_sleep$R[1]
  psg_rem_perc = psg_rem/psg_tst
  
  # contrust the PSG summary for one participant
  psg_summary <- c(psg_pids[j], psg_trt, psg_tib, psg_tst, psg_waso, psg_slp_eff, 
                   psg_slp_latency, psg_rem_latency, psg_wake, psg_n1, psg_n1_perc,
                   psg_n2, psg_n2_perc, psg_n3, psg_n3_perc, psg_rem, psg_rem_perc) %>% 
    as.numeric()
  # combine the single summary to the whoe summary data frame
  df.psg_summary <- rbind(df.psg_summary, psg_summary)
  
  # set variable names of the summary report
  if(j == 1){
    names(df.psg_summary) <- c("pid", "psg_trt", "psg_tib", "psg_tst", "psg_waso",
                               "psg_slp_eff", "psg_slp_latency", "psg_rem_latency",
                               "psg_wake", "psg_n1", "psg_n1_perc", "psg_n2",
                               "psg_n2_perc", "psg_n3", "psg_n3_perc", 
                               "psg_rem", "psg_rem_perc")
  }
  
}

# remove psg summary of participants who only have "?" data points
for (i in 1:nrow(df.psg_summary)){
  if(df.psg_summary$psg_tst[i] == 0) {
    # if their total sleep time = 0 (all data points are ?)
    df.psg_summary[i, 2:17] <- NA # assign NA to all summary statistics except the pid
  }
}

# mark the labels for stage
df.psg$stage <- factor(df.psg$stage, 
                         levels = c("?", "N1", "N2", "N3", "R", "W"),
                         labels = c("?", "N1", "N2", "N3", "R", "W"))

# # plot the staging data to check
# ggplot(df.psg %>% filter(pid == "2227"), aes(time, stage))+
#   geom_point(alpha = .5, size = 1)

kable(df.psg_summary, digit = 3)
```

```{r save workspace}
save.image('C:/Users/tepzh/Dropbox/Stanford/FYP/fyp_study2/data/workspace_fyp_study2.Rdata')

```


