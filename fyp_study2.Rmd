---
title: "fyp_study2"
author: "Jinxiao Zhang"
date: "January 25, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load library}
# library("knitr")
library("kableExtra") # for making nice tables
library("GGally")
library("lme4")
library("janitor")    # for cleaning column names
library("broom")      # for tidying up linear models
library("tidyverse")
library("cowplot")
library("lubridate") # load lubridate for time data
library("brms")

load("data/workspace_fyp_study2.Rdata")
```

```{r set theme}
theme_set(theme_classic() ) #set the theme
```


```{r participant list}
# (server must be mounted with appropriate file path)
bp_path <- "Z:/SBER/SBER1_physio_R56/data/Full_Study/byparticipant_data"
(bp_files <- list.files(bp_path))

# for FYP purpose
# authenticate
gs_auth()
gs_ls()
# import from Google Sheet
ss = gs_title("Study Quality Control: Data Checking")
gs_data_check <- gs_read(ss, ws = 2, range = cell_rows(3:107))
pids <- gs_data_check$`Participant ID`
```

```{r import raw task data}
# create the list of csv files of ER task
ercsvs <- character(0)
list_noS2 <- c() # list of participants who had no S2 .csv files
for(pid in pids){
  # create list of session 2 csvs
  s2path <- sprintf("%s/%s/session2", bp_path, pid)
  s2ls <- list.files(s2path, recursive = T, full.names = T)
  fn <- s2ls[c(grep("InstructedER_[0-9]{4}.*csv$", s2ls), 
               #grep("Instructed_ER_Task.*csv$", s2ls), 
               grep("Instructed_ER.*csv$", s2ls))]
  if(length(fn) > 0){
    #print(c(pid, length(fn)))
    ercsvs <- append(ercsvs, fn)
  }else{
    list_noS2 = append(list_noS2, pid)
  }
}
# sort the No_session2 list
list_noS2 <- sort(list_noS2)
# check the files in the No_session2 list
for(pid in list_noS2){
  # create list of session 2 csvs
  s2path <- sprintf("%s/%s/session2", bp_path, pid)
  s2ls <- list.files(s2path, recursive = T, full.names = T)
  # print the ID and the number of files in the "session2" folder
  print(c(pid,length(s2ls)))
}
# 1275 - copy (2 identical files) --> remove the copy
# 1574 - pt1, pt2 (2 files both only had 38 rows)
# 5767 - 2 files created at different time
# 1754 - 2 files created at different time
# 1016 - V1, V2, V3 (V1 and V2 are empty files though)
# 1023 - files in a subfolder "Random Files and test data" --> remove the files in the subfolder
# 3538 - 2 files created at different time
# 5175 - 1 file has full data (Nov01_1645) and the other doesn't have data (Nov01_1751)

# remove the wrong files
ercsvs <- ercsvs[c(-grep("copy", ercsvs), # contain "copy"
                   -grep("Random Files", ercsvs))] # in the "Random Files" folder




#import the raw data
agg_df_raw <- mutate_all(read.csv(ercsvs[1]), as.character) #aggregated raw data
for(i in 2:length(ercsvs)){
  # aggregate all csvs into 1 dataframe
  agg_df_raw <- bind_rows(agg_df_raw, mutate_all(read.csv(ercsvs[i]), as.character))
}


```

```{r fatigue and focus in task}

########## check the fatigue/quality rating in task #########

#get the block-wise rating data
fatigue_quality_rating <- agg_df_raw %>% 
  group_by(participant) %>% 
  filter(imageFile == "") %>% 
  select(participant, 
         Fatigue.response, 
         Data_Quality.response, 
         Watch_Quality.response,
         Distract_Quality.response,
         Reappraise_Quality.response) %>% 
  filter(row_number()!= 1) %>% # remove the trial before the first block
  mutate(fatigue = as.numeric(Fatigue.response),
         focus = as.numeric(Data_Quality.response),
         watch_quality = as.numeric(Watch_Quality.response),
         distract_quality = as.numeric(Distract_Quality.response),
         reappraise_quality = as.numeric(Reappraise_Quality.response),
         block = row_number()) %>% 
  filter(block <= 5)

# plot of ratings by block
# fatigue
p_fatigue <- ggplot(fatigue_quality_rating, aes(fatigue))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "fatigue rating by block")
p_focus <- ggplot(fatigue_quality_rating, aes(focus))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "focus rating by block")
p_watch <- ggplot(fatigue_quality_rating, aes(watch_quality))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "watch rating by block")
p_distract <- ggplot(fatigue_quality_rating, aes(distract_quality))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "distract rating by block")
p_reappraise <- ggplot(fatigue_quality_rating, aes(reappraise_quality))+
  geom_histogram(colour="black", fill="white")+
  #geom_density(alpha=.2, fill="red") +
  facet_wrap(.~block, ncol = 5)+
  labs(title = "reappraise rating by block")

plot_grid(p_fatigue, 
             p_focus, 
             p_watch,
             p_distract,
             p_reappraise,
             ncol=1)

# summarize each participant block ratings
fatigue_quality_summary <- fatigue_quality_rating %>% 
  group_by(participant) %>% 
  summarise(fatigue = mean(fatigue, na.rm = T),
            focus = mean(focus, na.rm = T),
            watch_quality = mean(watch_quality, na.rm = T),
            distract_quality = mean(distract_quality, na.rm = T),
            reappraise_quality = mean(reappraise_quality, na.rm = T),
            n = n()) %>% 
  gather(rating_type, score, fatigue:reappraise_quality)

# add levels of rating types
fatigue_quality_summary$rating_type <- factor(fatigue_quality_summary$rating_type,
                                              levels = c("fatigue",
                                                         "focus",
                                                         "watch_quality",
                                                         "distract_quality",
                                                         "reappraise_quality"))

# plot the distribution
ggplot(fatigue_quality_summary, aes(x = score))+
  geom_histogram(aes(y=..density..), colour="black", fill="white")+
  geom_density(alpha=.2, fill="red") +
  facet_wrap(.~rating_type, ncol = 3)

ggplot(fatigue_quality_summary, aes(x = score))+
  geom_histogram(aes(), colour="black", fill="white")+
  facet_wrap(.~rating_type, ncol = 3)


###### distribution of rating data #####
ggplot(df.ER_ind_wide, aes(watch_val_rating))+
  geom_histogram(aes(y = ..density..), fill = "white", color = "black")+
  geom_density(fill = "salmon", alpha = .5)+
  facet_wrap(. ~ intensity)+
  labs(title = "Distribution of valence rating")

ggsave("plots/ER_val_distribution.png", width = 8, height = 6)

ggplot(df.ER_ind_wide, aes(watch_arou_rating))+
  geom_histogram(aes(y = ..density..), fill = "white", color = "black")+
  geom_density(fill = "salmon", alpha = .5)+
  facet_wrap(. ~ intensity)+
  labs(title = "Distribution of arousal rating")

ggsave("plots/ER_arou_distribution.png", width = 8, height = 6)

```
```{r create ER task individual-level data}
# add 5175 data
# df.5175 <- read.csv("Z:/SBER/SBER1_physio_R56/data/Full_Study/byparticipant_data/5175/session2/5175_Instructed_ER_Task_2018_Nov_01_1645.csv") %>% 
#   mutate_all(as.character) %>% 
#   mutate(task = tolower(task),
#          task = gsub("rethink", "reappraise", task)) %>% 
#   filter(imageFile != "") %>% 
#   mutate(NegRating.response = as.numeric(NegRating.response),
#          ArousalRating.response = as.numeric(ArousalRating.response)) %>% 
#   rename(intensity = assign)
# 
# agg_df_update <- agg_df[1:61] %>% 
#   bind_rows(df.5175)


# create a clean data from the raw data
agg_df <-  agg_df_raw
agg_df$task <- tolower(agg_df$task) #change it to lower case
agg_df$task <- gsub("rethink", "reappraise", agg_df$task) #replace "rethink" with reappraise
#remove unnecessary rows of "instructions"
agg_df <- agg_df %>% 
  filter(imageFile != "")
#force variable type to be numeric
agg_df$NegRating.response <- as.numeric(agg_df$NegRating.response)
agg_df$ArousalRating.response <- as.numeric(agg_df$ArousalRating.response)

# remove participants who had less than 100 trials
agg_df <- agg_df %>% 
  group_by(participant) %>% 
  mutate(n_trial = n()) %>% 
  filter(n_trial > 100)
# change the variable "assign" to "intensity"
names(agg_df)[names(agg_df) == "assign"] <- "intensity"

# check the number of neutral, low, mid, and high trials (trial number = 15 for each condition)
agg_df %>% 
  group_by(participant, task, intensity) %>% 
  tally()
# write the data to the server
write_csv(agg_df, "Z:/SBER/SBER1_physio_R56/data/Full_Study/session2_data/ier/IER_trial_level.csv")

# individual-wise data
df.ER_ind <-  agg_df %>% 
  group_by(participant, task, intensity) %>% 
  summarise(NegRating.response = mean(NegRating.response, na.rm = TRUE),
            ArousalRating.response = mean(ArousalRating.response, na.rm = TRUE)) %>% 
  mutate(NegRating.response = ifelse(is.nan(NegRating.response), NA, NegRating.response),
         ArousalRating.response = ifelse(is.nan(ArousalRating.response), NA, ArousalRating.response))
# some participants have no response and should be replaced with NA, e.g. 3032, 5175

df.ER_ind$task <- factor(df.ER_ind$task, levels=c('watch', 'reappraise','distract'), ordered=TRUE)
df.ER_ind$intensity <- factor(df.ER_ind$intensity, levels = c("ntr", "low", "mid", "high"), ordered=TRUE)


################### change scores ####################
#valence ratings changes
temp_val_change <-  df.ER_ind %>% 
  select(-ArousalRating.response) %>% 
  spread(task, NegRating.response) %>% 
  group_by(participant, intensity) %>% 
  rename(watch_val_rating = watch, 
            distract_val_rating = distract, 
            reappraise_val_rating = reappraise)
#arousal ratings changes
temp_arou_change <-  df.ER_ind %>% 
  select(-NegRating.response) %>% 
  spread(task, ArousalRating.response) %>% 
  group_by(participant, intensity) %>% 
  rename(watch_arou_rating = watch, 
            distract_arou_rating = distract, 
            reappraise_arou_rating = reappraise)
# merge the 2 wide dataframes
df.ER_ind_wide <- merge(temp_val_change, temp_arou_change, 
                       by = c("participant","intensity"))
df.ER_ind_wide <- df.ER_ind_wide %>% 
  mutate(distract_val_change = watch_val_rating - distract_val_rating, 
         reappraise_val_change = watch_val_rating - reappraise_val_rating,
         distract_arou_change = watch_arou_rating - distract_arou_rating, 
         reappraise_arou_change = watch_arou_rating - reappraise_arou_rating,
         picture = ifelse(intensity == "ntr", "ntr", "neg")) #label the trials as eigher "neutral" or "negative

# write the data to the server
write_csv(df.ER_ind_wide,
          "Z:/SBER/SBER1_physio_R56/data/Full_Study/session2_data/ier/IER_participant_level.csv")
```



```{r visualization 1 PSG}
# hist(df.psg_summary$psg_tib, main = "PSG time in bed")
# hist(df.psg_summary$psg_tst, main = "PSG total sleep time")
# hist(df.psg_summary$psg_sws, main = "PSG SWS time")
# hist(df.psg_summary$psg_rem, main = "PSG REM sleep time")
# hist(df.psg_summary$psg_sws_perc, main = "PSG SWS percentage")
# hist(df.psg_summary$psg_rem_perc, main = "PSG REM percentage")
# 
# # REM and SWS
# p_psg1 <- ggplot(df.psg_summary,
#        aes(psg_rem, psg_sws))+
#   geom_point(alpha = .8)+
#   geom_smooth(method = "lm")+
#   labs(title = "REM ~ SWS (min)")
# 
# p_psg2 <- ggplot(df.psg_summary,
#        aes(psg_rem_perc, psg_sws_perc))+
#   geom_point(alpha = .8)+
#   geom_smooth(method = "lm")+
#   labs(title = "REM ~ SWS (%)")
# 
# # TST and REM
# p_psg3 <- ggplot(df.psg_summary,
#        aes(psg_rem, psg_tst))+
#   geom_point(alpha = .8)+
#   geom_smooth(method = "lm")+
#   labs(title = "REM ~ TST (min)")
# 
# # TST and REM
# p_psg4 <- ggplot(df.psg_summary,
#        aes(psg_sws, psg_tst))+
#   geom_point(alpha = .8)+
#   geom_smooth(method = "lm")+
#   labs(title = "SWS ~ TST (min)")


## correlation matrix ####
ggpairs(df.psg_summary %>%
          # filter(intensity == "high") %>% 
          select(psg_trt, psg_tib, psg_tst, 
                 psg_n1, psg_n2, psg_sws, psg_rem
                 # ,watch_val_rating, watch_arou_rating
                 )) +
  theme_grey()


ggsave("plots/psg_correlations.png", width = 10, height = 9)
# ggsave("plots/psg_reactivity_correlations.png", width = 12, height = 9)

# library(corrplot)
# M <- cor(df.er_psg %>% 
#            filter(intensity == "high") %>% 
#            select(psg_tst, psg_n1, psg_n2, psg_n3, psg_rem) %>% 
#            na.omit())
# corrplot.mixed(M, upper = "ellipse")

```

```{r visualization 2 REM and reactivity}
#### REM and valence-reactivity ####
p_rem1 <- ggplot(df.er_psg,
       aes(psg_rem, watch_val_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM and valence-reactivity (all cases)")

p_rem3 <- ggplot(df.er_psg,
       aes(psg_rem_perc, watch_val_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM% and valence-reactivity (all cases)")


#### REM and arousal-reactivity ####
p_rem5 <- ggplot(df.er_psg,
       aes(psg_rem, watch_arou_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM and arousal-reactivity (all cases)")

p_rem7 <- ggplot(df.er_psg,
       aes(psg_rem_perc, watch_arou_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM% and arousal-reactivity (all cases)")


plot_grid(p_rem1, p_rem5, p_rem3, p_rem7, ncol = 2)
ggsave("plots/rem-reactivity correlation.png", width = 12, height = 9)


```
```{r visualization 3 REM and regulation}
#### REM and regulation of valence ####
p_rem9 <- ggplot(df.er_psg,
       aes(psg_rem, reappraise_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM and reappraisal-valence change")

p_rem10 <- ggplot(df.er_psg,
       aes(psg_rem, distract_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM and distraction-valence change")

p_rem13 <- ggplot(df.er_psg,
       aes(psg_rem_perc, reappraise_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM% and reappraisal-valence change")

p_rem14 <- ggplot(df.er_psg,
       aes(psg_rem_perc, distract_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM% and distraction-valence change")


plot_grid(p_rem9, p_rem10, p_rem13, p_rem14)
ggsave("plots/rem-valence-regulation correlation.png", width = 12, height = 9)

#### REM and regulation of arousal ####

p_rem11 <- ggplot(df.er_psg,
       aes(psg_rem, reappraise_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM and reappraisal-arousal change")

p_rem12 <- ggplot(df.er_psg,
       aes(psg_rem, distract_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM and distraction-arousal change (REM > 0)")

p_rem15 <- ggplot(df.er_psg,
       aes(psg_rem_perc, reappraise_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM% and reappraisal-arousal change")

p_rem16 <- ggplot(df.er_psg,
       aes(psg_rem_perc, distract_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "REM% and distraction-arousal change")

plot_grid(p_rem11, p_rem12, p_rem15, p_rem16)
ggsave("plots/rem-arousal-regulation correlation.png", width = 12, height = 9)
```

```{r visualization 4 SWS and reactivity}
#### SWS and valence-reactivity ####
p_sws1 <- ggplot(df.er_psg,
       aes(psg_sws, watch_val_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS and valence-reactivity")

p_sws2 <- ggplot(df.er_psg ,
       aes(psg_sws_perc, watch_val_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS% and valence-reactivity")

#### SWS and arousal-reactivity ####
p_sws3 <- ggplot(df.er_psg,
       aes(psg_sws, watch_arou_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS and arousal-reactivity")

p_sws4 <- ggplot(df.er_psg,
       aes(psg_sws_perc, watch_arou_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS% and arousal-reactivity")

plot_grid(p_sws1, p_sws3, p_sws2, p_sws4)
ggsave("plots/sws-reactivity correlation.png", width = 12, height = 9)


# grid plot rem and sws
plot_grid(p_rem1, p_rem5, p_sws1, p_sws3)
ggsave("plots/rem_sws_reactivity.png", width = 10, height = 7.5)

```

```{r visualization 5 SWS and regulation}
#### SWS and valence-regulation ####
p_sws5 <- ggplot(df.er_psg,
       aes(psg_sws, reappraise_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS and reappraisal-valence change")

p_sws6 <- ggplot(df.er_psg,
       aes(psg_sws, distract_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS and distract-valence change")

p_sws7 <- ggplot(df.er_psg,
       aes(psg_sws_perc, reappraise_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS% and reappraisal-valence change")

p_sws8 <- ggplot(df.er_psg ,
       aes(psg_sws_perc, distract_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS% and distract-valence change")

plot_grid(p_sws5, p_sws6, p_sws7, p_sws8)
ggsave("plots/sws-valence-regulation correlation.png", width = 12, height = 9)

#### SWS and arousal-regulation ####
p_sws9 <- ggplot(df.er_psg ,
       aes(psg_sws, reappraise_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS and reappraisal-arousal change")

p_sws10 <- ggplot(df.er_psg,
       aes(psg_sws, distract_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS and distract-arousal change")

p_sws11 <- ggplot(df.er_psg ,
       aes(psg_sws_perc, reappraise_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS% and reappraisal-arousal change")

p_sws12 <- ggplot(df.er_psg,
       aes(psg_sws_perc, distract_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  labs(title = "SWS% and distract-arousal change")

plot_grid(p_sws9, p_sws10, p_sws11, p_sws12)
ggsave("plots/sws-arousal-regulation correlation.png", width = 12, height = 9)

```

```{r visualization 6 TST}
### TST (total sleep time) and reactivity ####
p_tst1 <- ggplot(df.er_psg,
       aes(psg_tst, watch_val_rating, color = intensity))+
  geom_point(alpha = .8)+
  # geom_text(data = df.er_psg %>% filter(intensity == "high"), 
  #           aes(label = participant), color = "black")+
  geom_smooth(method = "lm", se = F)+
  labs(title = "Total sleep time and valence-reactivity")

# p_tst1b <- ggplot(df.er_psg,
#        aes(psg_tst, watch_val_rating, color = intensity))+
#   geom_point(alpha = .8)+
#   geom_smooth(method = "lm")+
#   facet_wrap(.~intensity, nrow = 1)+
#   labs(title = "Total sleep time and valence-reactivity")

p_tst2 <- ggplot(df.er_psg,
       aes(psg_tst, watch_arou_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm", se = F)+
  labs(title = "Total sleep time and arousal-reactivity")

# p_tst2b <- ggplot(df.er_psg,
#        aes(psg_tst, watch_arou_rating, color = intensity))+
#   geom_point(alpha = .8)+
#   geom_smooth(method = "lm")+
#   facet_wrap(.~intensity, nrow = 1)+
#   labs(title = "Total sleep time and arousal-reactivity")
# 
# plot_grid(p_tst1b, p_tst2b, ncol = 1)
# ggsave("plots/tst-reactivity_separated.png", width = 12, height = 7)

### TST and regulation ####
p_tst3 <- ggplot(df.er_psg,
       aes(psg_tst, reappraise_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm", se = F)+
  labs(title = "Total sleep time and reappraisal-valence change")

p_tst4 <- ggplot(df.er_psg,
       aes(psg_tst, distract_val_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm", se = F)+
  labs(title = "Total sleep time and distraction-valence change")

p_tst5 <- ggplot(df.er_psg,
       aes(psg_tst, reappraise_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm", se = F)+
  labs(title = "Total sleep time and reappraisal-arousal change")

p_tst6 <- ggplot(df.er_psg,
       aes(psg_tst, distract_arou_change, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm", se = F)+
  labs(title = "Total sleep time and distraction-arousal change")

plot_grid(p_tst1, p_tst2, p_tst3, p_tst4, p_tst5, p_tst6, ncol = 2)
ggsave("plots/tst-reactivity and regulation correlation.png", width = 12, height = 13.5)

```

```{r visualization 7: mean-center the raw rating}

ggplot(df.er_psg,
       aes(psg_tst, watch_arou_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm", se = F)+
  geom_smooth(data = df.er_psg,
              aes(psg_tst, watch_arou_rating),
              linetype = 2,
              color = "black",
              method = "lm", se = F)+
  labs(title = "Total sleep time and arousal-reactivity (original)")


ggplot(df.er_psg,
       aes(psg_tst, watch_arou_rating))+
  geom_point(aes(color = intensity), alpha = .8)+
  geom_smooth(data = df.er_psg,
              aes(psg_tst, watch_arou_rating),
              linetype = 2,
              color = "black",
              method = "lm", se = F)+
  labs(title = "Total sleep time and arousal-reactivity (average)")


df.er_psg <- df.er_psg %>% 
  group_by(participant) %>% 
  mutate(watch_arou_rating_ctrd = scale(watch_arou_rating, 
                                        center=T, scale = F),
         watch_arou_rating_scld = scale(watch_arou_rating, 
                                        center=T, scale = T))

ggplot(df.er_psg,
       aes(psg_tst, watch_arou_rating_ctrd, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm", se = F)+
  geom_smooth(aes(psg_tst, watch_arou_rating_ctrd),
              linetype = 2,
              color = "black",
              method = "lm", se = F)+
  labs(title = "Total sleep time and arousal-reactivity (mean-centered)")


```



```{r analysis: PSG and ER-task correlation}
# REM duration
with(df.er_psg %>% filter(intensity == "low"),
     cor.test(psg_rem, watch_val_rating))
with(df.er_psg %>% filter(intensity == "low"),
     cor.test(psg_rem, watch_arou_rating))
# REM percentage %
with(df.er_psg %>% filter(intensity == "high", psg_rem_perc > 0),
     cor.test(psg_rem_perc, watch_val_rating))
with(df.er_psg %>% filter(intensity == "high", psg_rem_perc > 0),
     cor.test(psg_rem_perc, watch_arou_rating))


# SWS duration
with(df.er_psg %>% filter(intensity == "low"),
     cor.test(psg_sws, watch_val_rating))
with(df.er_psg %>% filter(intensity == "low"),
     cor.test(psg_sws, watch_arou_rating))
# SWS percentage %
with(df.er_psg %>% filter(intensity == "high", psg_rem_perc > 0),
     cor.test(psg_sws_perc, watch_val_rating))
with(df.er_psg %>% filter(intensity == "high", psg_rem_perc > 0),
     cor.test(psg_sws_perc, watch_arou_rating))

# TST duration
with(df.er_psg %>% filter(intensity == "high"),
     cor.test(psg_tst, watch_val_rating))
with(df.er_psg %>% filter(intensity == "high"),
     cor.test(psg_tst, watch_arou_rating))

with(df.er_psg %>% filter(intensity == "mid"),
     cor.test(psg_tst, watch_val_rating))
with(df.er_psg %>% filter(intensity == "mid"),
     cor.test(psg_tst, watch_arou_rating))

with(df.er_psg %>% filter(intensity == "low"),
     cor.test(psg_tst, watch_val_rating))
with(df.er_psg %>% filter(intensity == "low"),
     cor.test(psg_tst, watch_arou_rating))

# TST and regulation
with(df.er_psg %>% filter(intensity == "mid", psg_rem > 0),
     cor.test(psg_tst, reappraise_arou_change))
```

```{r analysis: REM and ER-task linear models}
## DV: valence rating ####
mod_tst1 <- lm(watch_val_rating ~ psg_tst, 
               data = df.er_psg %>% filter(intensity == "high" , psg_rem > 0))
summary(mod_tst1)

mod_rem1 <- lm(watch_val_rating ~ psg_rem, 
               data = df.er_psg %>% filter(intensity == "high" , psg_rem > 0))
summary(mod_rem1)

mod_rem2 <- lm(watch_val_rating ~ psg_tst + psg_rem, 
               data = df.er_psg %>% filter(intensity == "high" , psg_rem > 0))
summary(mod_rem2)

# The Bayes Factor way
mod_rem2_BF <- regressionBF(watch_val_rating ~ psg_tst + psg_rem, 
               data = df.er_psg %>% filter(intensity == "high") %>% na.omit())
plot(mod_rem2_BF)

## interaction effect

mod_rem3 <- lmer(watch_val_rating ~ psg_rem+intensity_num + 
                   (1+intensity_num|participant), 
               data = df.er_psg )
mod_rem4 <- lmer(watch_val_rating ~ psg_rem*intensity_num + 
                   (1+intensity_num|participant), 
               data = df.er_psg)
# lmerTest::lmer(scale(watch_val_rating) ~ scale(psg_rem)*scale(intensity_num) + 
#                    (1+scale(intensity_num)|participant), 
#                data = df.er_psg %>% filter(psg_rem > 0, psg_sws > 0)) %>% summary()
anova(mod_rem3, mod_rem4)


## DV: arousal rating ####
mod_tst2 <- lm(watch_arou_rating ~ psg_tst, 
               data = df.er_psg %>% filter(intensity == "high" , psg_rem > 0))
summary(mod_tst2)

mod_rem5 <- lm(watch_arou_rating ~ psg_rem, 
               data = df.er_psg %>% filter(intensity == "high" , psg_rem > 0))
summary(mod_rem5)

mod_rem6 <- lm(watch_arou_rating ~ psg_tst + psg_rem, 
               data = df.er_psg %>% filter(intensity == "high"))
summary(mod_rem6)

## interaction effect
mod_rem7 <- lmer(watch_arou_rating ~ psg_rem+intensity_num+ 
                   (1+intensity_num|participant), 
               data = df.er_psg)
mod_rem8 <- lmer(watch_arou_rating ~ psg_rem*intensity_num+ 
                   (1+intensity_num|participant), 
               data = df.er_psg)
# lmerTest::lmer(scale(watch_arou_rating) ~ scale(psg_rem)*scale(intensity_num) + 
#                    (1+scale(intensity_num)|participant), 
#                data = df.er_psg %>% filter(psg_rem > 0, psg_sws > 0)) %>% summary()
anova(mod_rem7, mod_rem8)
```

```{r analysis: SWS and ER-task linear models}
## DV: valence ratings ####
mod_sws1 <- lm(watch_val_rating ~ psg_sws,
               data = df.er_psg %>% filter(intensity == "high" , psg_rem > 0))
summary(mod_sws1)

mod_sws7 <- lm(watch_val_rating ~ psg_sws + psg_tst,
               data = df.er_psg %>% filter(intensity == "mid" , psg_rem > 0))
summary(mod_sws7)

# interaction
mod_sws2 <- lmer(watch_val_rating ~ psg_sws+intensity_num + 
                   (1+intensity_num|participant), 
               data = df.er_psg)
mod_sws3 <- lmer(watch_val_rating ~ psg_sws*intensity_num + 
                   (1+intensity_num|participant), 
               data = df.er_psg)
# lmerTest::lmer(scale(watch_val_rating) ~ scale(psg_sws)*scale(intensity_num) + 
#                    (1+scale(intensity_num)|participant), 
#                data = df.er_psg %>% filter(psg_rem > 0, psg_sws > 0)) %>% summary()
anova(mod_sws2, mod_sws3)

## DV: arousal ratings ####
mod_sws4 <- lm(watch_arou_rating ~ psg_sws,
               data = df.er_psg %>% filter(intensity == "high" , psg_rem > 0))
summary(mod_sws4)

mod_sws8 <- lm(watch_val_rating ~ psg_sws + psg_tst,
               data = df.er_psg %>% filter(intensity == "mid" , psg_rem > 0))
summary(mod_sws8)

# interaction
mod_sws5 <- lmer(watch_arou_rating ~ psg_sws+intensity_num +
                   (1+intensity_num|participant), 
               data = df.er_psg)
mod_sws6 <- lmer(watch_arou_rating ~ psg_sws*intensity_num + 
                   (1+intensity_num|participant), 
               data = df.er_psg)
# lmerTest::lmer(scale(watch_arou_rating) ~ scale(psg_sws)*scale(intensity_num) +
#                    (1+scale(intensity_num)|participant),
#                data = df.er_psg %>% filter(psg_rem > 0, psg_sws > 0)) %>% summary()
anova(mod_sws5, mod_sws6)
```

```{r analyses: TST and ER-task linear models}
## interaction
mod_tst4 <- lmer(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg) # %>% summary()
mod_tst4c <- lmer(watch_val_rating ~ psg_tst + intensity_num +
                    (1+intensity_num|participant), 
               data = df.er_psg)
anova(mod_tst4c, mod_tst4)


mod_tst3 <- lmer(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg) %>% summary()
mod_tst3c <- lmer(watch_arou_rating ~ psg_tst + intensity_num +
                    (1+intensity_num|participant), 
               data = df.er_psg)
anova(mod_tst3c, mod_tst3)

# plot the model prediction
p_tst_mod1 <- mod_tst4 %>% 
  augment()  %>% 
  clean_names() %>% 
  mutate(intensity = ifelse(intensity_num == 0, "ntr",
                            ifelse(intensity_num == 1, "low",
                                   ifelse(intensity_num == 2, "mid",
                                          "high"))),
         intensity = factor(intensity, levels = c("ntr", "low", "mid", "high"))) %>% 
  ggplot(aes(psg_tst, watch_val_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .3, color = "grey")+
  geom_point(aes(y = fitted), alpha = .5)+
  geom_smooth(aes(y = fitted), method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "model prediction: TST and valence-reactivity",
       x = "total sleep time")+
  theme(legend.position = "none")

p_tst_mod2 <- mod_tst3 %>% 
  augment()  %>% 
  clean_names() %>% 
  mutate(intensity = ifelse(intensity_num == 0, "ntr",
                            ifelse(intensity_num == 1, "low",
                                   ifelse(intensity_num == 2, "mid",
                                          "high"))),
         intensity = factor(intensity, levels = c("ntr", "low", "mid", "high"))) %>% 
  ggplot(aes(psg_tst, watch_arou_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .3, color = "grey")+
  geom_point(aes(y = fitted), alpha = .5)+
  geom_smooth(aes(y = fitted), method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "model prediction: TST and arousal-reactivity",
       x = "total sleep time")+
  theme(legend.position = "none")

plot_grid(p_tst_mod1, p_tst_mod2, ncol = 1)
ggsave("plots/tst-reactivity models_random_slope.png", width = 9, height = 6)
```

```{r check the stability of TST}
# correlation between psg_tst and psqi_sleep_durations
p_tst_stability1 <- ggplot(df.er_psg %>% filter(intensity == "high"), 
       aes(psg_tst, psqi_sleep_hours*60))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm")+
  geom_abline(slope = 1, intercept = 0, linetype = 2)

cor.test((df.er_psg%>% filter(intensity == "high"))$psg_tst, 
         (df.er_psg%>% filter(intensity == "high"))$psqi_sleep_hours)

#read diary data
df.diary <- read_csv(paste("Z:/SBER/SBER1_physio_R56/data/Full_Study/diary_Qualtrics",
                     "/processed/processed_ready_for_analysis/etidata_012919.csv",
                     sep = "")) %>% 
  filter(self_tst_min > 0, self_tst_min < 16*60)

df.diary_summary <- df.diary %>% 
  group_by(ID) %>% 
  summarise(diary_tst_mean = mean(self_tst_min),
            diary_tst_sd = sd(self_tst_min),
            diary_n_days = n(),
            diary_tst_ci = 1.96*diary_tst_sd/sqrt(n())) %>% 
  mutate(ID = as.character(ID))

df.er_psg_diary <- df.er_psg %>% 
  left_join(df.diary_summary, by = c("participant" = "ID"))

# correlation between psg_tst and average diary_tst
p_tst_stability2 <- ggplot(df.er_psg_diary %>% filter(intensity == "high"), 
       aes(psg_tst, diary_tst_mean))+
  geom_linerange(aes(ymax = diary_tst_mean + diary_tst_ci, 
                     ymin= diary_tst_mean - diary_tst_ci),
                 alpha = .5)+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm")+
  # xlim(300, 550)+ ylim(300, 550)+
  geom_abline(slope = 1, intercept = 0, linetype = 2)

# correlation between psqi_sleep_duration and average diary_tst
p_tst_stability3 <- ggplot(df.er_psg_diary %>% filter(intensity == "high"), 
       aes(psqi_sleep_hours*60, diary_tst_mean))+
  geom_pointrange(aes(ymax = diary_tst_mean + diary_tst_ci, 
                     ymin= diary_tst_mean - diary_tst_ci),
                 alpha = .5,
                 size = .25,
                 position = position_jitter(height = 0, width = 20))+
  # geom_point(alpha = .5)+
  geom_smooth(method = "lm")+
  geom_abline(slope = 1, intercept = 0, linetype = 2)

plot_grid(p_tst_stability2, p_tst_stability1, p_tst_stability3)
# ggsave("plots/tst_stability.png", width = 8, height = 6)
```

```{r visualization: habitual sleep and reactivity}
# diary sleep duration
p_diary_tst1 <- ggplot(df.er_psg_diary, 
       aes(diary_tst_mean, watch_val_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .3)+
  geom_smooth(method = "lm")+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "diary sleep and valence-reactivity",
       x = "diary average sleep time")+
  theme(legend.position = "none")

p_diary_tst2 <- ggplot(df.er_psg_diary, 
       aes(diary_tst_mean, watch_arou_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .3)+
  geom_smooth(method = "lm")+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "diary sleep and arousal-reactivity",
       x = "diary average sleep time")+
  theme(legend.position = "none")

plot_grid(p_diary_tst1, p_diary_tst2, ncol = 1)
ggsave("plots/diary_tst_reactivity.png", width = 9, height = 6)

# PSQI sleep duration
p_psqi_tst1 <- ggplot(df.er_psg_diary, 
       aes(psqi_sleep_hours, watch_val_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .3)+
  geom_smooth(method = "lm")+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "PSQI sleep and valence-reactivity",
       x = "PSQI sleep duration",
       y = "arousal rating")+
  theme(legend.position = "none")

p_psqi_tst2 <- ggplot(df.er_psg_diary, 
       aes(psqi_sleep_hours, watch_arou_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .3)+
  geom_smooth(method = "lm")+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "PSQI sleep and arousal-reactivity",
       x = "PSQI sleep duration",
       y = "arousal rating")+
  theme(legend.position = "none")

plot_grid(p_psqi_tst1, p_psqi_tst2, ncol = 1, labels = c("a", "b"))
ggsave("plots/psqi_tst_reactivity.png", width = 9, height = 6)
```

```{r model: habitual sleep and reactivity}
# diary sleep
lmerTest::lmer(scale(watch_val_rating) ~ scale(diary_tst_mean)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg_diary) %>% summary()

lmerTest::lmer(scale(watch_arou_rating) ~ scale(diary_tst_mean)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg_diary) %>% summary()

# psqi sleep
lmerTest::lmer(scale(watch_val_rating) ~ scale(psqi_sleep_hours)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg_diary) %>% summary()

lmerTest::lmer(scale(watch_arou_rating) ~ scale(psqi_sleep_hours)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg_diary) %>% summary()
```



```{r analysis: REM vs. SWS}
## compare SWS and REM
lm(watch_val_rating ~ psg_rem + psg_sws, 
   data = df.er_psg %>% filter(intensity == "high", psg_rem > 0)) %>% 
  summary()

lm(watch_arou_rating ~ psg_rem + psg_sws, 
   data = df.er_psg %>% filter(intensity == "high", psg_rem > 0)) %>% 
  summary()
```

## Trial-level models
```{r analysis: trial-level model, warning=F}
# construct the trial-level data frame
df.er_trial <- agg_df %>% 
  select(participant, block, imageFile, task, intensity, 
         NegRating.response, NegRating.responseTime,
         ArousalRating.response, ArousalRating.responseTime) %>% 
  mutate_at(vars(NegRating.response, NegRating.responseTime,
                 ArousalRating.response, ArousalRating.responseTime), 
            funs(as.numeric)) %>% 
  rename(val_rating = NegRating.response,
         val_RT = NegRating.responseTime,
         arou_rating = ArousalRating.response,
         arou_RT = ArousalRating.responseTime) %>% 
  filter(!is.na(val_rating), !is.na(arou_rating)) # remove NA data

# merge with the psg data
df.er_trial_psg <- left_join(df.er_trial, df.psg_summary, 
                             by = c("participant" = "pid")) %>%
  left_join(., 
            df.ind_diff %>% filter(Progress == 100)%>% select(partID, age, gender),
            by = c("participant" = "partID")) %>% 
  mutate(age = as.numeric(age),
         stimulus = as.numeric(factor(imageFile)),
         intensity_num = ifelse(intensity == "ntr", 0,
                                ifelse(intensity == "low", 1,
                                       ifelse(intensity == "mid", 2,
                                              ifelse(intensity == "high", 3,
                                                     NA)))))
```

Model comparison results showed that there was a significant TST x intensity interaction for valence ratings in the trial-level model, $\chi^2(1) = 5.59, p = .018$. There was also a significant TST x intensity interaction for arousal ratings in the trial-level model, $\chi^2(1) = 19.82, p < .001$. 
```{r trial-level model: Gaussian family}
# build the lmer model for "watch" trials (reactivity)
# valence rating
mod_tst_lmer1 <- lmer(val_rating ~ intensity_num*psg_tst + 
                        (1|participant)+
                        (1|stimulus), 
                      data = df.er_trial_psg %>% filter(task == "watch"))
# model results in table
# mod_tst_lmer1 %>% tidy() %>% kable(digits = 3)

mod_tst_lmer1c <- lmer(val_rating ~ intensity_num+psg_tst + 
                        (1|participant)+
                        (1|stimulus), 
                      data = df.er_trial_psg %>% filter(task == "watch"))

# trial-level model for valence
anova(mod_tst_lmer1c, mod_tst_lmer1)


# arousal rating
mod_tst_lmer2 <- lmer(arou_rating ~ intensity_num*psg_tst + 
                        (1|participant)+
                        (1|stimulus), 
                      data = df.er_trial_psg %>% filter(task == "watch"))
# model results in table
# mod_tst_lmer2 %>% tidy() %>% kable(digits = 3)

mod_tst_lmer2c <- lmer(arou_rating ~ intensity_num+psg_tst + 
                        (1|participant)+
                        (1|stimulus), 
                      data = df.er_trial_psg %>% filter(task == "watch"))

# trial-level model for arousal
anova(mod_tst_lmer2c, mod_tst_lmer2)
```

The trial-level models predictions are plotted below in comparison to the raw data points.
```{r visualize the trial-level models}
p_tst_lmer1 <- mod_tst_lmer1 %>% 
  augment() %>%
  clean_names() %>% 
  mutate(intensity_num = factor(intensity_num, 
                                labels = c("ntr", "low", "mid", "high"))) %>% 
  ggplot(aes(psg_tst, fitted, color = intensity_num))+
  geom_point(aes(y = val_rating), alpha = .1, color = "grey", 
             position = position_jitter(width = 0, height = .1))+
  geom_point(alpha = .1)+
  geom_smooth(method = "lm")+
  labs(title = "Trial-level model: valence", y = "Valence")+
  facet_wrap(.~intensity_num, nrow = 1)+
  theme(legend.position = "none")

p_tst_lmer2 <- mod_tst_lmer2 %>% 
  augment() %>%
  clean_names() %>% 
  mutate(intensity_num = factor(intensity_num, 
                                labels = c("ntr", "low", "mid", "high"))) %>% 
  ggplot(aes(psg_tst, fitted, color = intensity_num))+
  geom_point(aes(y = arou_rating), alpha = .1, color = "grey", 
             position = position_jitter(width = 0, height = .1))+
  geom_point(alpha = .1)+
  geom_smooth(method = "lm")+
  labs(title = "Trial-level model: arousal", y = "Arousal")+
  facet_wrap(.~intensity_num, nrow = 1)+
  theme(legend.position = "none")

plot_grid(p_tst_lmer1, p_tst_lmer2, ncol = 1)
# ggsave("plots/trial_level_models.png", width = 8, height = 6)
```

```{r trial model: ordered logit}

# factorize valence and arousal rating
df.er_trial_psg <- df.er_trial_psg %>% 
  ungroup() %>% 
  mutate(val_rating_factored = factor(val_rating),
         arou_rating_factored = factor(arou_rating))

# valence
mod_tst1_brm_trial <- brm(val_rating ~ psg_tst*intensity_num +
                      (1|participant)+
                      (1|stimulus), 
                    data = df.er_trial_psg %>% filter(task == "watch"), 
                    family = cumulative,
                    save_all_pars = T,
                    file = "tst_brm_trial1",
                    iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst1_brm_trial %>% plot(N = 4)
mod_tst1_brm_trial %>% 
  augment() %>% 
  view()

# arousal
mod_tst2_brm_trial <- brm(arou_rating ~ psg_tst*intensity_num +
                      (1|participant)+
                      (1|stimulus), 
                    data = df.er_trial_psg %>% filter(task == "watch"), 
                    family = cumulative,
                    save_all_pars = T,
                    file = "tst_brm_trial2",
                    iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst2_brm_trial %>% plot(N = 4)
```

```{r visualize the trial-level clmm models}
ggplot(df.er_trial_psg, aes(psg_tst, val_rating))+
  geom_bar(aes(fill = val_rating_factored),
           stat = "identity")+
  # geom_area(fill = "#eaac9e",
  #           color = "black",
  #           size = 0.2)+
  # geom_ribbon(aes(ymin = val_rating, ymax = 1),
  #             fill = "#92bbd1",
  #             color = "black",
  #             size = 0.2)+
  facet_wrap(.~ intensity)


p_tst1_brm_trial <- mod_tst1_brm_trial %>% 
  broom.mixed::augment() %>%
  clean_names() %>% 
  mutate(intensity_num = factor(intensity_num, 
                                labels = c("ntr", "low", "mid", "high"))) %>% 
  ggplot(aes(psg_tst, fitted, color = intensity_num))+
  geom_point(aes(y = val_rating), alpha = .1, color = "grey", 
             position = position_jitter(width = 0, height = .1))+
  geom_point(alpha = .1)+
  geom_smooth(method = "lm")+
  labs(title = "Trial-level model: valence", y = "Valence")+
  facet_wrap(.~intensity_num, nrow = 1)+
  theme(legend.position = "none")

plot_grid(p_tst_lmer1, p_tst_lmer2, ncol = 1)
# ggsave("plots/trial_level_models.png", width = 8, height = 6)
```



### Bayesian models

We also built the same models using Bayesian package `brms` and compute the Bayes Factor for the effect of REM and SWS. First, we built the bayesian models with TST x intensity for both valence and arousal. The trace plots showed that the Monte Carlo sampling was effective.
```{r TST model using Bayesian brms}
# build mod_tst1 using brms (weakly-informative prior)
mod_tst1_brm <- brm(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "tst1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst1_brm %>% plot(N = 6)

# build mod_tst2 using brms (weakly-informative prior)
mod_tst2_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "tst2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst2_brm %>% plot(N = 6)
```

Second, we built the bayesian models with TST x intensity plus REM duration for both valence and arousal. The trace plots showed that the Monte Carlo sampling was effective. Following that, we computed the Bayes Factor of the REM effect.
```{r REM model using Bayesian brms}
# build mod_rem1 using brms (weakly-informative prior)
mod_rem1_brm <- brm(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      scale(psg_rem) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "rem1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# show the posterior
# print(mod_rem1_brm)
# the trace plots
# plot(mod_rem1_brm, N = 7)

# mod_rem1_brm %>%
#   posterior_samples() %>%
#   select(starts_with("b_psg_rem")) %>%
#   gather("variable", "value") %>%
#   ggplot(aes(y = variable, x = value))+
#   tidybayes::geom_halfeyeh()+
#   geom_vline(xintercept = 0, linetype = 2)+
#   labs(title = "Model on valence")
# ggsave("../../figures/rem_valence_posterior.png", width = 4, height = 3)


# build mod_rem2 using brms (weakly-informative prior)
mod_rem2_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      scale(psg_rem) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "rem2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# print the model results
# print(mod_rem2_brm)
# the trace plot
# plot(mod_rem2_brm, N = 7)
```

```{r Bayes factor: REM, message=F, results='hide'}
# compare the rem_model with the tst_model
# for valence
BF_rem1 = bayes_factor(mod_rem1_brm, mod_tst1_brm)
# for arousal
BF_rem2 = bayes_factor(mod_rem2_brm, mod_tst2_brm)

```
```{r Bayes factor: REM2}
# pring the BFs
BF_rem1
BF_rem2
```

For valence, the Bayes Factor of REM is `r BF_rem1[1] %>% as.numeric() %>% round(4)`. For arousal, the Bayes Factor of REM is `r BF_rem2[1] %>% as.numeric() %>% round(4)`. Both results provided evidence for a null effect of REM on emotional reactivity.

Third, we built the bayesian models with TST x intensity plus SWS duration for both valence and arousal. The trace plots showed that the Monte Carlo sampling was effective. Following that, we computed the Bayes Factor of the SWS effect.
```{r SWS model using Bayesian brms}
# build mod_sws1 using brms (weakly-informative prior)
mod_sws1_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                      scale(psg_sws) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "sws1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# # show the posterior
# print(mod_sws1_brm)
# # the trace plots
# plot(mod_sws1_brm, N = 7)

# build mod_sws2 using brms (weakly-informative prior)
mod_sws2_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                      scale(psg_sws) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "sws2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# # print the model results
# print(mod_sws2_brm)
# # the trace plot
# plot(mod_sws2_brm, N = 7)
```

```{r Bayes factor: SWS, message=F, results='hide'}
# compare the rem_model with the tst_model
# for valence
BF_sws1 = bayes_factor(mod_sws1_brm, mod_tst1_brm)
BF_sws1
# for arousal
BF_sws2 = bayes_factor(mod_sws2_brm, mod_tst2_brm)
BF_sws2
```
```{r Bayes factor: SWS2}
# pring the BFs
BF_sws1
BF_sws2
```
For arousal, the Bayes Factor of SWS is `r BF_sws1[1] %>% as.numeric() %>% round(4)`. For arousal, the Bayes Factor of SWS is `r BF_sws2[1] %>% as.numeric() %>% round(4)`. Both results provided evidence for a null effect of SWS on emotional reactivity.

Finally, we built the bayesian models for understanding the effects of all sleep stages at the same time. All variables are standardized before fitting the model so that the parameter posteriors are in the same scale. The trace plots showed that the Monte Carlo sampling was effective. The model results are presented in the following tables.
```{r sleep stages model using Bayesian brms, warning=F}
# build mod_sleep1 using brms
mod_sleep1_brm = brm(scale(watch_val_rating)~scale(psg_n1)+scale(psg_n2)+
                       scale(psg_sws)+scale(psg_rem)+
                       scale(intensity_num) + 
                       (1+intensity_num|participant),
                     data = df.er_psg %>% filter(!is.na(psg_tst)),
                     family = gaussian,
                     file = "sleep1_brm",
                     iter = 2000, warmup = 500, chains = 4, cores = 2)

# plot(mod_sleep1_brm, N = 8)
# # print the table
# tidy(mod_sleep1_brm) %>% 
#   filter(grepl("b_", term)) %>% 
#   kable(digits = 3)

# build mod_sleep2 using brms
mod_sleep2_brm = brm(scale(watch_arou_rating) ~ ~scale(psg_n1)+scale(psg_n2)+
                       scale(psg_sws)+scale(psg_rem)+
                       scale(intensity_num)+
                       (1+intensity_num|participant),
                     data = df.er_psg %>% filter(!is.na(psg_tst)),
                     family = gaussian,
                     file = "sleep2_brm",
                     iter = 2000, warmup = 500, chains = 4, cores = 2)

# plot(mod_sleep2_brm, N = 8)
# # print the table
# tidy(mod_sleep2_brm) %>% 
#   filter(grepl("b_", term)) %>% 
#   kable(digits = 3)

```

The posterior distributions of the effects of each sleep stage on valence and arousal are presented in the figure below. Consistent with the results of the non-Bayesian models, Stage 2 sleep seemed to have the largest effect on emotional ractivity among all sleep stages.
```{r visualize the posterior of sleep stages, warning=F}
# plot the standardized b for each predictor
p_sleep1_brm <- mod_sleep1_brm %>%
  posterior_samples() %>%
  select(starts_with("b_scale")) %>%
  gather("variable", "value") %>%
  ggplot(aes(y = variable, x = value))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  labs(title = "Model on valence")


# plot the standardized b for each predictor
p_sleep2_brm <- mod_sleep2_brm %>%
  posterior_samples() %>%
  select(starts_with("b_scale")) %>%
  gather("variable", "value") %>%
  ggplot(aes(y = variable, x = value))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  labs(title = "Model on arousal")

plot_grid(p_sleep1_brm, p_sleep2_brm, ncol = 1)
# ggsave("../../figures/sleep_stages_posterior.png", width = 8, height = 10)
```


```{r simulation}
# simulation dataframe
df.simul <- df.er_psg %>% 
  filter(!is.na(psg_tst), intensity == "high") 


fun.simulate <- function(){
  # reactivity 1: only related to TST
  df.simul$reactivity1 <- df.simul$psg_tst*0.01 + rnorm(41, 0, 1)
  # reactivity 2: related to TST and REM
  df.simul$reactivity2 <- df.simul$psg_tst*0.008 + df.simul$psg_rem*0.01 + rnorm(41, 0, 1)
  
  # ggpairs(df.simul %>% select(psg_tst, psg_rem, psg_rem_perc, reactivity1, reactivity2))
  # ggsave("plots/simulation_correlation.png", width = 8, height = 7)

  m1 <- lm(reactivity1 ~ psg_tst + psg_rem, data = df.simul) %>% tidy()
  m2 <- lm(reactivity1 ~ psg_rem_perc, data = df.simul) %>% tidy()
  m3 <- lm(reactivity2 ~ psg_tst + psg_rem, data = df.simul) %>% tidy()
  m4 <- lm(reactivity2 ~ psg_rem_perc, data = df.simul) %>% tidy()
  
  return(c(m1$p.value[3], m2$p.value[2], m3$p.value[3], m4$p.value[2]))
}

# simulate 1k times
sim_result <- replicate(10000, fun.simulate())


# construc the data fame from the simulated results
sim_result <- t(sim_result) %>% as.tibble()
names(sim_result) <- c("p1_reactivity1", "p2_reactivity1", 
                         "p1_reactivity2", "p2_reactivity2")
sim_result_t <- sim_result %>% 
  gather(p_type, p_value, p1_reactivity1:p2_reactivity2) %>% 
  separate(col = p_type, into = c("p_type", "DV"), sep = "_")

sim_result_t$p_type <- factor(sim_result_t$p_type, levels = c("p2", "p1"))

# summarize p-values
sim_result_t %>% 
  group_by(p_type, DV) %>% 
  summarise(number = sum(p_value < .05),
            rej_rate = number/n()) %>% 
  arrange(DV)



ggplot(sim_result_t, 
       aes(x = p_value))+
  geom_density(aes(fill = p_type), alpha = .3)+
  geom_text(data = data.frame(DV = c("reactivity1", "reactivity2"),
                       text_x = c(.5, .5),
                       text_y = c(5 ,5),
                       text = c("null effect data:\np1 (using tst+rem) rejection rate = .0478\np2 (using rem%) rejection rate = .0343",
                                "REM effect data:\np1 (using tst+rem) rejection rate = .4251\n p2 (using rem%) rejection rate = .4695"),
                       p_type = c("1","2")
                       ),
            aes(text_x, text_y,
                label = text))+
  facet_wrap(DV ~ ., ncol = 1)+
  geom_vline(xintercept = .05, 
             linetype = 2)

ggsave("plots/simulation_distribution.png", width = 8, height = 6)
```

```{r check ERP data}
library(readxl)
df.LPP <- read_excel('C:/Users/tepzh/Desktop/R56 EEG/28-Feb-2019-trial-LPP-export.xlsx')
df.LPP$task <- factor(df.LPP$task, levels = c("Watch", "Rethink", "Distract"))
df.LPP$intensity <- factor(df.LPP$assign, levels = c("ntr", "low", "mid", "high"))
df.LPP$Subject <- factor(df.LPP$Subject)


df.LPP_summary_by_task <- df.LPP %>% 
  group_by(Subject, intensity) %>% 
                summarise(LPP_early_P3PzP4 = mean(LPP_early_P3PzP4),
                          LPP_mid_P3PzP4 = mean(LPP_mid_P3PzP4),
                          LPP_late_P3PzP4 = mean(LPP_late_P3PzP4))

# can gather the data and plot once here!
# early-LPP
p_LPP_early <- ggplot(df.LPP, # %>% filter(intensity %in% c("ntr", "high")),
       aes(intensity, 
           LPP_early_P3PzP4, 
           group = Subject, 
           color = Subject))+
  geom_violin(data = df.LPP_summary_by_task,
              aes(group = NULL),
              color = "black",
              fill = "white")+
  stat_summary(fun.y = "mean",
               geom = "line",
               alpha = .3)+
  stat_summary(fun.y = "mean",
               geom = "point",
               alpha = .3)+
  stat_summary(aes(group = NULL),
               size = 4,
               alpha = .5,
               color = "black",
               fun.y = "mean",
               geom = "point")+
  stat_summary(aes(group = NULL),
               size = 1,
               alpha = .5,
               color = "black",
               fun.data = "mean_cl_boot",
               geom = "linerange")+
  labs(title = "early LPP (300 - 500 ms)")+
  #ylim(-0.010, 0.005)+
  theme(legend.position = "none")


# mid-LPP
p_LPP_mid <-ggplot(df.LPP, # %>% filter(intensity %in% c("ntr", "high")),
       aes(intensity, 
           LPP_mid_P3PzP4, 
           group = Subject, 
           color = Subject))+
  geom_violin(data = df.LPP_summary_by_task,
              aes(group = NULL),
              color = "black",
              fill = "white")+
  stat_summary(fun.y = "mean",
               geom = "line",
               alpha = .3)+
  stat_summary(fun.y = "mean",
               geom = "point",
               alpha = .3)+
  stat_summary(aes(group = NULL),
               size = 4,
               alpha = .5,
               color = "black",
               fun.y = "mean",
               geom = "point")+
  stat_summary(aes(group = NULL),
               size = 1,
               alpha = .5,
               color = "black",
               fun.data = "mean_cl_boot",
               geom = "linerange")+
  labs(title = "mid LPP (500 - 1000 ms)")+
  #ylim(-0.010, 0.005)+
  theme(legend.position = "none")

# late-LPP
p_LPP_late <-ggplot(df.LPP, # %>% filter(intensity %in% c("ntr", "high")),
       aes(intensity, 
           LPP_late_P3PzP4, 
           group = Subject, 
           color = Subject))+
  geom_violin(data = df.LPP_summary_by_task,
              aes(group = NULL),
              color = "black",
              fill = "white")+
  stat_summary(fun.y = "mean",
               geom = "line",
               alpha = .3)+
  stat_summary(fun.y = "mean",
               geom = "point",
               alpha = .3)+
  stat_summary(aes(group = NULL),
               size = 4,
               alpha = .5,
               color = "black",
               fun.y = "mean",
               geom = "point")+
  stat_summary(aes(group = NULL),
               size = 1,
               alpha = .5,
               color = "black",
               fun.data = "mean_cl_boot",
               geom = "linerange")+
  labs(title = "late LPP (1000 - 5000 ms)")+
  #ylim(-0.010, 0.005)+
  theme(legend.position = "none")

plot_grid(p_LPP_early, p_LPP_mid, p_LPP_late, ncol = 2)
ggsave("plots/LPP amplitudes.png", width = 8, height = 6)
```


```{r save workspace}
save.image('data/workspace_fyp_study2.Rdata')
```

