---
title: "model_analysis"
author: "Jinxiao Zhang"
date: "April 30, 2019"
output: html_document
---

## load the package and data
```{r load library, warning=F, message=F}
# library("knitr")
# library("kableExtra") # for making nice tables
# library("GGally")
library("lme4")
library("janitor")    # for cleaning column names
library("broom")      # for tidying up linear models
library("tidyverse")
library("cowplot")
# library("lubridate") # load lubridate for time data
library("brms")
library(MuMIn) # calculate R-squared for glm

load("data/workspace_fyp_study2.Rdata")

# load("df.er_psg.Rdata")
```

## Frequentist linear mixed effects models

### The model resutls
```{r TST and ER-task linear models}
## interaction
mod_tst4 <- lmer(watch_val_rating ~ psg_tst*intensity_num +
                   (1+intensity_num|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst),
                                           psqi_sd > 4))
# r.squaredGLMM(mod_tst4)

# mod_tst4c <- lmer(watch_val_rating ~ psg_tst + intensity_num +
#                     (1+intensity_num|participant),
#                data = df.er_psg %>% filter(!is.na(psg_tst)))
# anova(mod_tst4c, mod_tst4)

# To get the standardized coefficients
lmerTest::lmer(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()


mod_tst3 <- lmer(watch_arou_rating ~ psg_tst*intensity_num +
                   (1+intensity_num|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst),
                                           psqi_sd > 4))


# r.squaredGLMM(mod_tst3)

# mod_tst3c <- lmer(watch_arou_rating ~ psg_tst + intensity_num +
#                     (1+intensity_num|participant),
#                data = df.er_psg %>% filter(!is.na(psg_tst)))
# anova(mod_tst3c, mod_tst3)

# To get the standardized coefficients
sd_intensity = (df.er_psg %>% filter(!is.na(psg_tst)))$intensity_num %>% sd()
mean_intensity = (df.er_psg %>% filter(!is.na(psg_tst)))$intensity_num %>% mean()
sd_psg_tst = (df.er_psg %>% filter(!is.na(psg_tst)))$psg_tst %>% sd()
mean_psg_tst = (df.er_psg %>% filter(!is.na(psg_tst)))$psg_tst %>% mean()

lmerTest::lmer(scale(watch_arou_rating) ~ scale(psg_tst)*(scale(intensity_num)) +
                   (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()

# calculate the simple slope betas
# betas for psg_tst
1.520e-01 + 7.565e-02*(c(0,1,2,3) - mean_intensity)/sd_intensity
# betas for intensity
6.421e-01 + 7.565e-02*c(-1, 0, 1)
(mean_psg_tst + c(-1, 0, 1)*sd_psg_tst)/60
```
```{r visualization TST - reactivity}
# df.er_psg$intensity_num <- factor(df.er_psg$intensity_num,
#                                         labels = c("neutral", "low-negative",
#                                                    "mid-negative", "high-negative"))

p_psg_tst1 <- ggplot(df.er_psg %>% 
                       filter(# psqi_sleep_hours>4, 
                              # psg_tst > 330, psg_tst < 500,
                              !is.na(psg_tst)), 
       aes(psg_tst, watch_val_rating, 
           color = factor(intensity_num))) +
  geom_point(alpha = .3)+
  geom_smooth(method = "lm", se = F)+
  facet_wrap(.~factor(intensity_num,
                      labels = c("neutral", "low-negative",
                                 "mid-negative", "high-negative")), nrow = 1)+
  labs(#title = "a. PSQI sleep and valence-reactivity",
    x = "PSG sleep duration (min)",
    y = "valence rating",
    color = "Intensity")+
  theme(legend.position = "none")

p_psg_tst2 <- ggplot(df.er_psg %>% 
                       filter(# psqi_sleep_hours>4, 
                              # psg_tst > 330, psg_tst < 500,
                              !is.na(psg_tst)), 
       aes(psg_tst, watch_arou_rating, 
           color = factor(intensity_num))) +
  geom_point(alpha = .3)+
  geom_smooth(method = "lm", se = F)+
  # facet_wrap(.~factor(intensity_num,
  #                     labels = c("neutral", "low-negative",
  #                                "mid-negative", "high-negative")), nrow = 1)+
  labs(#title = "b. PSQI sleep and arousal-reactivity",
       x = "PSG sleep duration (min)",
       y = "arousal rating",
    color = "Intensity")+
  theme(legend.position = "none")

plot_grid(p_psg_tst1, p_psg_tst2, ncol = 1)
# ggsave("plots/tst-reactivity.png", width = 7, height = 6)
ggsave("plots/tst-reactivity_facet.png", width = 9, height = 6)


# correlations
df.er_psg %>% 
  filter(!is.na(df.er_psg$psg_tst)) %>% 
  select(participant, intensity, psg_tst, watch_val_rating, watch_arou_rating) %>% 
  gather(type, rating, starts_with("watch")) %>%
  unite(type, c(type, intensity), sep = "_") %>% 
  spread(type, rating) %>% 
  select(-participant) %>% 
  psych::corr.test()
```


```{r intensity as categorical predictors}

fit.tst1 <- lmer(watch_arou_rating ~ psg_tst*intensity +
                   (1|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst)))
fit.tst1c <- lmer(watch_arou_rating ~ psg_tst+intensity +
                   (1|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst)))
anova(fit.tst1, fit.tst1c)

fit.tst1 %>% 
  augment() %>% 
  clean_names() %>% 
  ggplot(aes(psg_tst, fitted, color = intensity))+
  geom_point(aes(y = watch_arou_rating),
             color = "grey", alpha = .3)+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)

fit.tst1 %>% r.squaredGLMM()
```


### Plot the models
```{r plot the models}
# plot the model prediction
p_tst_mod1 <- mod_tst4 %>% 
  augment()  %>% 
  clean_names() %>% 
  mutate(intensity = ifelse(intensity_num == 0, "neutral",
                            ifelse(intensity_num == 1, "low-negative",
                                   ifelse(intensity_num == 2, "mid-negative",
                                          "high-negative"))),
         intensity = factor(intensity, levels = c("neutral", "low-negative", 
                                                  "mid-negative", "high-negative"))) %>% 
  ggplot(aes(psg_tst, watch_val_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .3, color = "grey")+
  geom_point(aes(y = fitted), alpha = .3)+
  geom_smooth(aes(y = fitted), method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "a. PSG sleep duration and valence-reactivity",
       x = "total sleep time",
       y = "valence rating")+
  theme(legend.position = "none")

p_tst_mod2 <- mod_tst3 %>% 
  augment()  %>% 
  clean_names() %>% 
    mutate(intensity = ifelse(intensity_num == 0, "neutral",
                            ifelse(intensity_num == 1, "low-negative",
                                   ifelse(intensity_num == 2, "mid-negative",
                                          "high-negative"))),
         intensity = factor(intensity, levels = c("neutral", "low-negative", 
                                                  "mid-negative", "high-negative"))) %>% 
  ggplot(aes(psg_tst, watch_arou_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .3, color = "grey")+
  geom_point(aes(y = fitted), alpha = .3)+
  geom_smooth(aes(y = fitted), method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "b. PSG sleep duration and arousal-reactivity",
       x = "total sleep time",
       y = "arousal rating")+
  theme(legend.position = "none")

plot_grid(p_tst_mod1, p_tst_mod2, ncol = 1)
ggsave("plots/tst-reactivity models_random_slope.png", width = 9, height = 6)


# plot the interaction the other way
ggplot(data = df.er_psg %>% filter(!is.na(psg_tst)),
       aes(intensity, watch_arou_rating, color = psg_tst)) +
  geom_point(alpha = .5, 
             position = position_jitter(width = .2))+
  scale_color_gradient2(midpoint= mean((df.er_psg %>% filter(!is.na(psg_tst)))$psg_tst), 
                       low="blue", mid="white",high="red", 
                       space ="Lab",
                       name = "sleep duration")
```

### add REM to the model
```{r REM and reactivity beyond TST}
# valence rating
lmerTest::lmer(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) +
                 scale(psg_rem)+
                 (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()


# arousal rating
lmerTest::lmer(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                 scale(psg_rem)+
                 (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()
```
### add SWS to the model
```{r SWS and reactivity beyond TST}
# valence rating
lmerTest::lmer(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) +
                 scale(psg_sws)+
                 (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()

# arousal rating
lmerTest::lmer(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                 scale(psg_sws)+
                 (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()
```


## Bayesian models

We also built the same models using Bayesian package `brms` and compute the Bayes Factor for the effect of REM and SWS. First, we built the bayesian models with TST x intensity for both valence and arousal. The trace plots showed that the Monte Carlo sampling was effective.

### TST models (default priors)
```{r TST model using Bayesian brms}
# build mod_tst1 using brms (weakly-informative prior)
mod_tst1_brm <- brm(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "tst1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst1_brm %>% plot(N = 6)
# posterior_summary(mod_tst1_brm)[1:8,] %>% round(digits =  4)
print(mod_tst1_brm)
# bayes_R2(mod_tst1_brm)

# check the default prior
prior_summary(mod_tst1_brm)


# build mod_tst2 using brms (weakly-informative prior)
mod_tst2_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "tst2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst2_brm %>% plot(N = 6)
# posterior_summary(mod_tst2_brm)[1:8,] %>% round(digits =  4)
print(mod_tst2_brm)
# bayes_R2(mod_tst2_brm)

mod_tst2c_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)+scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "tst2c_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

# compare with the model with only intensity
bayes_factor(mod_tst2_brm, mod_tst2c_brm)
```
### add some priors
```{r add our own priors}
# get_prior(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
#                       (1+scale(intensity_num)|participant),
#           data = df.er_psg %>% filter(!is.na(psg_tst)))

mod_tst1_brm_prior <- brm(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
                      data = df.er_psg %>% filter(!is.na(psg_tst)),
                      prior = c(
                        prior(normal(0, 1), class = "b", coef = "scalepsg_tst"),
                        prior(normal(0, 1), class = "b", coef = "scaleintensity_num"),
                        prior(normal(0, 1), class = "b", coef = "scalepsg_tst:scaleintensity_num"),
                        # prior(lkj(1), class = "cor"),
                        prior(normal(0, 1), class = "Intercept"),
                        prior(cauchy(0, 1), class = "sd")
                      ),
                      family = gaussian,
               save_all_pars = T,
               file = "tst1_brm_prior",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst1_brm_prior %>% plot(N = 6)
# posterior_summary(mod_tst1_brm_prior)[1:8,] %>% round(digits =  4)
print(mod_tst1_brm_prior)

# check the default prior
prior_summary(mod_tst1_brm_prior)




mod_tst2_brm_prior <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
                      data = df.er_psg %>% filter(!is.na(psg_tst)),
                      prior = c(
                        prior(normal(0, 1), class = "b", coef = "scalepsg_tst"),
                        prior(normal(0, 1), class = "b", coef = "scaleintensity_num"),
                        prior(normal(0, 1), class = "b", coef = "scalepsg_tst:scaleintensity_num"),
                        # prior(lkj(1), class = "cor"),
                        prior(normal(0, 1), class = "Intercept"),
                        prior(cauchy(0, 1), class = "sd")
                      ),
                      family = gaussian,
               save_all_pars = T,
               file = "tst2_brm_prior",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst1_brm_prior %>% plot(N = 6)
# posterior_summary(mod_tst2_brm_prior)[1:8,] %>% round(digits =  4)
print(mod_tst2_brm_prior)

# check the default prior
prior_summary(mod_tst2_brm_prior)
```

### plot the models
```{r plot brm model predictions}
# calculate the mean and Sd for DVs
mean_watch_val = mean((df.er_psg %>% filter(!is.na(psg_tst)))$watch_val_rating)
sd_watch_val = sd((df.er_psg %>% filter(!is.na(psg_tst)))$watch_val_rating)
mean_watch_arou = mean((df.er_psg %>% filter(!is.na(psg_tst)))$watch_arou_rating)
sd_watch_arou = sd((df.er_psg %>% filter(!is.na(psg_tst)))$watch_arou_rating)


p_tst1_brm <- mod_tst1_brm %>% 
  fitted() %>% 
  data.frame() %>% 
  mutate(estimate_raw = Estimate*sd_watch_val + mean_watch_val) %>% 
  bind_cols(df.er_psg %>% filter(!is.na(psg_tst))) %>% 
  mutate(intensity = factor(intensity, levels = c("ntr", "low", "mid", "high"))) %>% 
  ggplot(aes(psg_tst, watch_val_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .5, color = "grey")+
  geom_point(aes(y = estimate_raw), alpha = .5)+
  geom_smooth(aes(y = estimate_raw), method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "brm prediction: TST and valence-reactivity",
       x = "total sleep time")+
  theme(legend.position = "none")


p_tst2_brm <- mod_tst1_brm %>% 
  fitted() %>% 
  data.frame() %>% 
  mutate(estimate_raw = Estimate*sd_watch_arou + mean_watch_arou) %>% 
  bind_cols(df.er_psg %>% filter(!is.na(psg_tst))) %>% 
  mutate(intensity = factor(intensity, levels = c("ntr", "low", "mid", "high"))) %>% 
  ggplot(aes(psg_tst, watch_arou_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .5, color = "grey")+
  geom_point(aes(y = estimate_raw), alpha = .5)+
  geom_smooth(aes(y = estimate_raw), method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "brm prediction: TST and arousal-reactivity",
       x = "total sleep time")+
  theme(legend.position = "none")

plot_grid(p_tst1_brm, p_tst2_brm, ncol = 1)
# ggsave("plots/brm_models_tst.png", width = 9, height = 6)
```


Second, we built the bayesian models with TST x intensity plus REM duration for both valence and arousal. The trace plots showed that the Monte Carlo sampling was effective. Following that, we computed the Bayes Factor of the REM effect.

### add REM
```{r REM model using Bayesian brms}
# build mod_rem1 using brms (weakly-informative prior)
mod_rem1_brm <- brm(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      scale(psg_rem) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "rem1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# print the model results
print(mod_rem1_brm)
# the trace plots
# plot(mod_rem1_brm, N = 7)
# posterior_summary(mod_rem1_brm)[1:9,] %>% round(digits =  4)


# build mod_rem2 using brms (weakly-informative prior)
mod_rem2_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      scale(psg_rem) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "rem2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# print the model results
print(mod_rem2_brm)
# the trace plot
# plot(mod_rem2_brm, N = 7)
# posterior_summary(mod_rem2_brm)[1:9,] %>% round(digits =  4)


# plot the posterior distribution of rem coefficient
p_rem1_brm <- mod_rem1_brm %>%
  posterior_samples() %>%
  select(starts_with("b_"), -contains("intercept")) %>%
  gather("predictor", "beta") %>%
  mutate(predictor = factor(predictor, 
                            levels = c("b_scalepsg_rem", 
                                       "b_scalepsg_tst:scaleintensity_num",
                                       "b_scalepsg_tst",
                                       "b_scaleintensity_num"),
                            labels = c("rem", "tst x intensity", 
                                       "tst", "intensity"))) %>% 
  ggplot(aes(y = predictor, x = beta))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  xlim(-.3, .8)+
  labs(title = "a. Valence: posterior distribution of betas")

p_rem2_brm <- mod_rem2_brm %>%
  posterior_samples() %>%
  select(starts_with("b_"), -contains("intercept")) %>%
  gather("predictor", "beta") %>%
  mutate(predictor = factor(predictor, 
                            levels = c("b_scalepsg_rem", 
                                       "b_scalepsg_tst:scaleintensity_num",
                                       "b_scalepsg_tst",
                                       "b_scaleintensity_num"),
                            labels = c("rem", "tst x intensity", 
                                       "tst", "intensity"))) %>% 
  ggplot(aes(y = predictor, x = beta))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  xlim(-.3, .8)+
  labs(title = "b. Arousal: posterior distribution of betas")

plot_grid(p_rem1_brm, p_rem2_brm, ncol = 1)
ggsave("plots/rem_posterior.png", width = 8, height = 6)
```

```{r Bayes factor: REM, message=F, results='hide'}
# compare the rem_model with the tst_model
# for valence
BF_rem1 = bayes_factor(mod_rem1_brm, mod_tst1_brm) # p(mod_rem1_brm)/p(mod_tst1_brm)
# for arousal
BF_rem2 = bayes_factor(mod_rem2_brm, mod_tst2_brm)

# bayes_factor uses the bridgesampling method (https://github.com/quentingronau/bridgesampling)

# print the BFs
BF_rem1
BF_rem2

```
```{r brm hypothesis: REM}
# hypothesis (look at Post.Prob and Evid.Ratio)
hypothesis(mod_rem1_brm,
           hypothesis = "abs(scalepsg_rem) > 0.1")
hypothesis(mod_rem2_brm,
           hypothesis = "abs(scalepsg_rem) > 0.1")

# # compare waic
# compare_ic(waic(mod_rem1_brm), waic(mod_tst1_brm))
# compare_ic(waic(mod_rem2_brm), waic(mod_tst2_brm))
```

For valence, the Bayes Factor of REM is `r BF_rem1[1] %>% as.numeric() %>% round(4)`. For arousal, the Bayes Factor of REM is `r BF_rem2[1] %>% as.numeric() %>% round(4)`. Both results provided evidence for a null effect of REM on emotional reactivity.

Third, we built the bayesian models with TST x intensity plus SWS duration for both valence and arousal. The trace plots showed that the Monte Carlo sampling was effective. Following that, we computed the Bayes Factor of the SWS effect.

### SWS model
```{r SWS model using Bayesian brms}
# build mod_sws1 using brms (weakly-informative prior)
mod_sws1_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                      scale(psg_sws) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "sws1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# # show the posterior
print(mod_sws1_brm)
# # the trace plots
# plot(mod_sws1_brm, N = 7)
# posterior_summary(mod_sws1_brm)[1:9,] %>% round(digits =  4)

# build mod_sws2 using brms (weakly-informative prior)
mod_sws2_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                      scale(psg_sws) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "sws2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# # print the model results
print(mod_sws2_brm)
# # the trace plot
# plot(mod_sws2_brm, N = 7)
# posterior_summary(mod_sws2_brm)[1:9,] %>% round(digits =  4)

# plot the posterior distribution of rem coefficient
p_sws1_brm <- mod_sws1_brm %>%
  posterior_samples() %>%
  select(starts_with("b_"), -contains("intercept")) %>%
  gather("predictor", "beta") %>%
  mutate(predictor = factor(predictor, 
                            levels = c("b_scalepsg_sws", 
                                       "b_scalepsg_tst:scaleintensity_num",
                                       "b_scalepsg_tst",
                                       "b_scaleintensity_num"),
                            labels = c("sws", "tst x intensity", 
                                       "tst", "intensity"))) %>% 
  ggplot(aes(y = predictor, x = beta))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  xlim(-.3, .8)+
  labs(title = "c. Valence: posterior distribution of betas")

p_sws2_brm <- mod_sws2_brm %>%
  posterior_samples() %>%
  select(starts_with("b_"), -contains("intercept")) %>%
  gather("predictor", "beta") %>%
  mutate(predictor = factor(predictor, 
                            levels = c("b_scalepsg_sws", 
                                       "b_scalepsg_tst:scaleintensity_num",
                                       "b_scalepsg_tst",
                                       "b_scaleintensity_num"),
                            labels = c("sws", "tst x intensity", 
                                       "tst", "intensity"))) %>% 
  ggplot(aes(y = predictor, x = beta))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  xlim(-.3, .8)+
  labs(title = "d. Arousal: posterior distribution of betas")

plot_grid(p_sws1_brm, p_sws2_brm, ncol = 1)
ggsave("plots/sws_posterior.png", width = 8, height = 6)


plot_grid(p_rem1_brm, p_rem2_brm, p_sws1_brm, p_sws2_brm, ncol = 1)
ggsave("plots/rem_sws_posterior.png", width = 8, height = 10)
```

```{r Bayes factor: SWS, message=F, results='hide'}
# compare the rem_model with the tst_model
# for valence
BF_sws1 = bayes_factor(mod_sws1_brm, mod_tst1_brm)
# for arousal
BF_sws2 = bayes_factor(mod_sws2_brm, mod_tst2_brm)

# print the BFs
BF_sws1
BF_sws2
```

```{r brm hypothesis: SWS}
# hypothesis (look at Post.Prob and Evid.Ratio)
hypothesis(mod_sws1_brm,
           hypothesis = "abs(scalepsg_sws) > 0.1") %>% print(digits = 4)
hypothesis(mod_sws2_brm,
           hypothesis = "abs(scalepsg_sws) > 0.1") %>% print(digits = 4)
```
For arousal, the Bayes Factor of SWS is `r BF_sws1[1] %>% as.numeric() %>% round(4)`. For arousal, the Bayes Factor of SWS is `r BF_sws2[1] %>% as.numeric() %>% round(4)`. Both results provided evidence for a null effect of SWS on emotional reactivity.

Finally, we built the bayesian models for understanding the effects of all sleep stages at the same time. All variables are standardized before fitting the model so that the parameter posteriors are in the same scale. The trace plots showed that the Monte Carlo sampling was effective. The model results are presented in the following tables.

### model with all 4 stages
```{r sleep stages model using Bayesian brms, warning=F}
# build mod_sleep1 using brms
mod_sleep1_brm = brm(scale(watch_val_rating)~scale(psg_n1)+scale(psg_n2)+
                       scale(psg_sws)+scale(psg_rem)+
                       scale(intensity_num) + 
                       (1+intensity_num|participant),
                     data = df.er_psg %>% filter(!is.na(psg_tst)),
                     family = gaussian,
                     file = "sleep1_brm",
                     iter = 2000, warmup = 500, chains = 4, cores = 2)

mod_sleep1_brm_new = brm(scale(watch_val_rating)~scale(psg_n1)+scale(psg_n2)+
                           scale(psg_sws)+scale(psg_rem)+
                           scale(intensity_num) + 
                           scale(intensity_num):scale(psg_tst)+
                           (1+intensity_num|participant),
                         data = df.er_psg %>% filter(!is.na(psg_tst)),
                         family = gaussian,
                         file = "sleep1_brm_new",
                         iter = 2000, warmup = 500, chains = 4, cores = 2)

# plot(mod_sleep1_brm, N = 8)
# posterior_summary(mod_sleep1_brm_new)[1:7,] %>% round(digits =  4)

# build mod_sleep2 using brms
mod_sleep2_brm = brm(scale(watch_arou_rating) ~ ~scale(psg_n1)+scale(psg_n2)+
                       scale(psg_sws)+scale(psg_rem)+
                       scale(intensity_num)+
                       (1+intensity_num|participant),
                     data = df.er_psg %>% filter(!is.na(psg_tst)),
                     family = gaussian,
                     file = "sleep2_brm",
                     iter = 2000, warmup = 500, chains = 4, cores = 2)

mod_sleep2_brm_new = brm(scale(watch_arou_rating)~scale(psg_n1)+scale(psg_n2)+
                           scale(psg_sws)+scale(psg_rem)+
                           scale(intensity_num) + 
                           scale(intensity_num):scale(psg_tst)+
                           (1+intensity_num|participant),
                         data = df.er_psg %>% filter(!is.na(psg_tst)),
                         family = gaussian,
                         file = "sleep2_brm_new",
                         iter = 2000, warmup = 500, chains = 4, cores = 2)

# plot(mod_sleep2_brm_new, N = 8)
# print(mod_sleep2_brm_new)
# posterior_summary(mod_sleep2_brm_new)[1:7,] %>% round(digits =  4)

hypothesis(mod_sleep2_brm_new, hypothesis = "scalepsg_rem > 0")
```

The posterior distributions of the effects of each sleep stage on valence and arousal are presented in the figure below. Consistent with the results of the non-Bayesian models, Stage 2 sleep seemed to have the largest effect on emotional ractivity among all sleep stages.
```{r visualize the posterior of sleep stages, warning=F}
# plot the standardized b for each predictor
p_sleep1_brm <- mod_sleep1_brm_new %>%
  posterior_samples() %>%
  select(starts_with("b_scale")) %>%
  gather("variable", "value") %>%
  ggplot(aes(y = variable, x = value))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  #geom_vline(xintercept = c(-.1, .1), linetype = 2, color = "blue")+
  labs(title = "Model on valence")


# plot the standardized b for each predictor
p_sleep2_brm <- mod_sleep2_brm_new %>%
  posterior_samples() %>%
  select(starts_with("b_scale")) %>%
  gather("variable", "value") %>%
  ggplot(aes(y = variable, x = value))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  #geom_vline(xintercept = c(-.1, .1), linetype = 2, color = "blue")+
  labs(title = "Model on arousal")

plot_grid(p_sleep1_brm, p_sleep2_brm, ncol = 1)
# ggsave("../../figures/sleep_stages_posterior.png", width = 8, height = 10)
```

## Trait-level information (individual difference questionnaires)
```{r pers and psqi}
## add psqi and pers to the data
df.er_psg <- df.er_psg %>% 
  left_join(df.ind_diff %>% 
              select(partID, starts_with("psqi_"), starts_with("pers_")),
            by = c("participant" = "partID"))

# fyp final sample
psych::corr.test(df.er_psg %>%
                   filter(intensity == "high", 
                          psqi_sd > 4,
                          !is.na(df.er_psg$psg_tst)) %>%
                   select(pers_anr, pers_apr, psqi_sd, psqi_c1, psqi_se,psqi_lat))
# cor.test(df.er_psg$pers_anr[df.er_psg$intensity=="high" & 
#                               !is.na(df.er_psg$psg_tst)],
#          df.er_psg$psqi_sd[df.er_psg$intensity=="high" &
#                                       !is.na(df.er_psg$psg_tst)])


# R56 final sample
# cor.test(df.ind_diff$pers_anr, df.ind_diff$psqi_sd)
# psych::corr.test(df.ind_diff %>%
#                    select(pers_anr, psqi_sd, psqi_c1, psqi_se, psqi_c4, psqi_lat, psqi_c2))


# scatter plots
p_psqi_pers1 <- ggplot(df.er_psg %>% filter(intensity == "high", 
                                            !is.na(psg_tst),
                                            psqi_sd > 4),
       aes(psqi_sd, pers_anr))+
  geom_point(alpha = .5, position = position_jitter(width = .2))+
  geom_smooth(method = "lm")+
  labs(#title = "b",
       x = "PSQI sleep duration",
       y = "PERS negative reactivity")
# ggsave("plots/psqi_pers_neg.png", width = 4, height = 3)

p_psqi_pers2 <-ggplot(df.er_psg %>% filter(intensity == "high", 
                                           !is.na(psg_tst),
                                            psqi_sd > 4),
       aes(psqi_sd, pers_apr))+
  geom_point(alpha = .5, position = position_jitter(width = .2))+
  geom_smooth(method = "lm")+
  labs(# title = "a",
       x = "PSQI sleep duration",
       y = "PERS positive reactivity")

plot_grid(p_psqi_pers2, p_psqi_pers1, labels = c("a", "b"))
ggsave("plots/psqi_pers.png", width = 8, height = 4)

```
```{r visualization: habitual sleep and reactivity}
df.er_psg_diary$intensity_num <- factor(df.er_psg_diary$intensity_num,
                                        labels = c("neutral", "low-negative",
                                                   "mid-negative", "high-negative"))

p_psqi_tst1 <- ggplot(df.er_psg_diary %>% filter(psqi_sleep_hours>4, !is.na(psg_tst)), 
       aes(psqi_sleep_hours, watch_val_rating, 
           color = intensity_num)) +
  geom_point(alpha = .3, position = position_jitter(width = .2))+
  geom_smooth(method = "lm", se = F)+
  facet_wrap(.~intensity_num, nrow = 1)+
  labs(#title = "a. PSQI sleep and valence-reactivity",
    x = "PSQI sleep duration",
    y = "valence rating",
    color = "Intensity")+
  theme(legend.position = "none")

p_psqi_tst2 <- ggplot(df.er_psg_diary %>% filter(psqi_sleep_hours>4, 
                                                 !is.na(psg_tst)), 
       aes(psqi_sleep_hours, watch_arou_rating, 
           color = intensity_num)) +
  geom_point(alpha = .3, position = position_jitter(width = .2))+
  geom_smooth(method = "lm", se = F)+
  # facet_wrap(.~intensity_num, nrow = 1)+
  labs(#title = "b. PSQI sleep and arousal-reactivity",
       x = "PSQI sleep duration",
       y = "arousal rating",
    color = "Intensity")+
  theme(legend.position = "none")

plot_grid(p_psqi_tst1, p_psqi_tst2, ncol = 1)
# ggsave("plots/psqi_tst_reactivity.png", width = 7, height = 6)
ggsave("plots/psqi_tst_reactivity_facet.png", width = 9, height = 6)
```


```{r lmer: habitual sleep and reactivity}
# psqi sleep
lmerTest::lmer(scale(watch_val_rating) ~ scale(psqi_sd)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% 
                 filter(!is.na(df.er_psg$psg_tst), psqi_sd> 4)) %>% 
  summary()


lmerTest::lmer(scale(watch_arou_rating) ~ scale(psqi_sd)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% 
                 filter(!is.na(df.er_psg$psg_tst), psqi_sd> 4)) %>% 
  summary()


# correlations
df.er_psg %>% 
  filter(!is.na(df.er_psg$psg_tst), psqi_sd> 4) %>% 
  select(participant, intensity, psqi_sd, watch_val_rating, watch_arou_rating) %>% 
  gather(type, rating, starts_with("watch")) %>%
  mutate(type = str_c(type, intensity, sep = "_")) %>% 
  select(-intensity) %>% 
  spread(type, rating) %>% 
  select(-participant) %>% 
  psych::corr.test()

```

```{r brm: habitual sleep and reactivity}
# psqi sleep
## valence
mod_psqi1_brm <- brm(scale(watch_val_rating) ~ scale(psqi_sd)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "psqi1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

mod_intensity1_brm <- brm(scale(watch_val_rating) ~ scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "intensity1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

bayes_factor(mod_psqi1_brm, mod_intensity1_brm)

## arousal
mod_psqi2_brm <- brm(scale(watch_arou_rating) ~ scale(psqi_sd)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "psqi2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

mod_intensity2_brm <- brm(scale(watch_arou_rating) ~ scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "intensity2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

bayes_factor(mod_psqi2_brm, mod_intensity2_brm)
```

```{r pers and ER reactivity}
df.er_psg$intensity = factor(df.er_psg$intensity, levels = c("ntr", "low", "mid", "high"))

p_pers1 <- ggplot(df.er_psg,
       aes(pers_anr, watch_val_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "PERS negative reactivity and valence-reactivity")

p_pers2 <- ggplot(df.er_psg,
       aes(pers_anr, watch_arou_rating, color = intensity))+
  geom_point(alpha = .8)+
  geom_smooth(method = "lm")+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "PERS negative reactivity and arousal-reactivity")

plot_grid(p_pers1, p_pers2, ncol = 1)
ggsave("plots/pers_task_reactivity.png", width = 9, height = 6)

# correlation between pers and valence rating (neg pictures)
# cor.test(df.er_psg$pers_anr[df.er_psg$intensity!="ntr" & !is.na(df.er_psg$psg_tst)],
#          df.er_psg$watch_val_rating[df.er_psg$intensity!="ntr" & !is.na(df.er_psg$psg_tst)])
# # correlation between pers and arousal rating (neg pictures)
# cor.test(df.er_psg$pers_anr[df.er_psg$intensity!="ntr" & !is.na(df.er_psg$psg_tst)],
#          df.er_psg$watch_arou_rating[df.er_psg$intensity!="ntr" & !is.na(df.er_psg$psg_tst)])

df.er_psg_neg <- df.er_psg %>% 
  filter(intensity != "ntr", !is.na(df.er_psg$psg_tst)) %>% 
  group_by(participant) %>% 
  summarise(pers_anr = mean(pers_anr),
            watch_val_rating = mean(watch_val_rating),
            watch_arou_rating = mean(watch_arou_rating))

cor.test(df.er_psg_neg$pers_anr, df.er_psg_neg$watch_val_rating)
cor.test(df.er_psg_neg$pers_anr, df.er_psg_neg$watch_arou_rating)
```

```{r psg sleep and pers}
# correlation
ggplot(df.er_psg %>% filter(intensity=="high", psqi_sd > 4),
       aes(psg_tst, pers_anr))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm")+
  # annotate("text", x = 1.2, y = 550, label = "r = -.03", 
  #          color = "blue", size = 6)+
  labs(#title = "PERS negative reactivity and PSG TST",
       x = "PSG sleep duration (min)",
       y = "PERS negative reactivity")

ggsave("plots/tst-pers_neg.png", width = 4, height = 3)


cor.test(df.er_psg$pers_anr[df.er_psg$intensity=="high" &
                              !is.na(df.er_psg$psg_tst) &
                              df.er_psg$psqi_sd > 4],
         df.er_psg$psg_tst[df.er_psg$intensity=="high" &
                                      !is.na(df.er_psg$psg_tst) &
                              df.er_psg$psqi_sd > 4])


```



## Session information
```{r session_info}
sessionInfo()
```

## Save the workspace
```{r save workspace, eval=F}
save.image('data/workspace_fyp_study2.Rdata')
```
