---
title: "model_analysis"
author: "Jinxiao Zhang"
date: "April 30, 2019"
output: html_document
---

## load the package and data
```{r load library, warning=F, message=F}
# library("knitr")
# library("kableExtra") # for making nice tables
# library("GGally")
library("lme4")
library("janitor")    # for cleaning column names
library("broom")      # for tidying up linear models
library("tidyverse")
library("cowplot")
# library("lubridate") # load lubridate for time data
library("brms")
library(MuMIn) # calculate R-squared for glm

df.er_psg <- df.er_psg %>% 
  mutate(psg_tst = psg_tst/60)
# load("df.er_psg.Rdata")
```

## Frequentist linear mixed effects models

### The model resutls
```{r TST and ER-task linear models}
## interaction
## Valence
mod_tst4 <- lmer(watch_val_rating ~ psg_tst*intensity_num +
                   (1+intensity_num|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst)))
# r.squaredGLMM(mod_tst4)

# mod_tst4c <- lmer(watch_val_rating ~ psg_tst + intensity_num +
#                     (1+intensity_num|participant),
#                data = df.er_psg %>% filter(!is.na(psg_tst)))
# anova(mod_tst4c, mod_tst4)

# To get the standardized coefficients
lmerTest::lmer(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()



## Arousal
mod_tst3 <- lmer(watch_arou_rating ~ psg_tst*intensity_num +
                   (1+intensity_num|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst)))


# r.squaredGLMM(mod_tst3)

# mod_tst3c <- lmer(watch_arou_rating ~ psg_tst + intensity_num +
#                     (1+intensity_num|participant),
#                data = df.er_psg %>% filter(!is.na(psg_tst)))
# anova(mod_tst3c, mod_tst3)

# To get the standardized coefficients
sd_intensity = (df.er_psg %>% filter(!is.na(psg_tst)))$intensity_num %>% sd()
mean_intensity = (df.er_psg %>% filter(!is.na(psg_tst)))$intensity_num %>% mean()
sd_psg_tst = (df.er_psg %>% filter(!is.na(psg_tst)))$psg_tst %>% sd()
mean_psg_tst = (df.er_psg %>% filter(!is.na(psg_tst)))$psg_tst %>% mean()

lmerTest::lmer(scale(watch_arou_rating) ~ scale(psg_tst)*(scale(intensity_num)) +
                   (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()

# calculate the simple slope betas
# betas for psg_tst
1.520e-01 + 7.565e-02*(c(0,1,2,3) - mean_intensity)/sd_intensity
# betas for intensity
6.421e-01 + 7.565e-02*c(-1, 0, 1)
(mean_psg_tst + c(-1, 0, 1)*sd_psg_tst)/60
```

```{r visualization TST - reactivity}
# df.er_psg$intensity_num <- factor(df.er_psg$intensity_num,
#                                         labels = c("neutral", "low-negative",
#                                                    "mid-negative", "high-negative"))

p_psg_tst1 <- ggplot(df.er_psg %>% 
                       filter(# psqi_sleep_hours>4, 
                              # psg_tst > 330, psg_tst < 500,
                              !is.na(psg_tst)), 
       aes(psg_tst, watch_val_rating, 
           color = factor(intensity_num))) +
  geom_point(alpha = .3)+
  geom_smooth(method = "lm", se = T)+
  facet_wrap(.~factor(intensity_num,
                      labels = c("neutral", "low-negative",
                                 "mid-negative", "high-negative")), nrow = 1)+
  labs(title = "a. PSG sleep duration and valence-reactivity",
    x = "PSG sleep duration",
    y = "valence rating",
    color = "Intensity")+
  theme(legend.position = "none")

p_psg_tst2 <- ggplot(df.er_psg %>% 
                       filter(# psqi_sleep_hours>4, 
                              # psg_tst > 330, psg_tst < 500,
                              !is.na(psg_tst)), 
       aes(psg_tst, watch_arou_rating, 
           color = factor(intensity_num))) +
  geom_point(alpha = .3)+
  geom_smooth(method = "lm", se = T)+
  facet_wrap(.~factor(intensity_num,
                      labels = c("neutral", "low-negative",
                                 "mid-negative", "high-negative")), nrow = 1)+
  labs(title = "a. PSG sleep duration arousal-reactivity",
       x = "PSG sleep duration",
       y = "arousal rating",
    color = "Intensity")+
  theme(legend.position = "none")

plot_grid(p_psg_tst1, p_psg_tst2, ncol = 1)
# ggsave("plots/tst-reactivity.png", width = 5.8, height = 6)
ggsave("plots/tst-reactivity_facet.png", width = 9, height = 6)


# correlations
cor.test(df.er_psg$watch_arou_rating[df.er_psg$intensity=="high" &
                              !is.na(df.er_psg$psg_tst)],
         df.er_psg$psg_tst[df.er_psg$intensity=="high" &
                                      !is.na(df.er_psg$psg_tst)])

df.er_psg %>% 
  filter(!is.na(df.er_psg$psg_tst)) %>% 
  select(participant, intensity, psg_tst, watch_val_rating, watch_arou_rating) %>% 
  gather(type, rating, starts_with("watch")) %>%
  unite(type, c(type, intensity), sep = "_") %>% 
  spread(type, rating) %>% 
  select(-participant) %>% 
  psych::corr.test()
```


```{r intensity as categorical predictors}

fit.tst1 <- lmer(watch_arou_rating ~ psg_tst*intensity +
                   (1|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst)))
fit.tst1c <- lmer(watch_arou_rating ~ psg_tst+intensity +
                   (1|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst)))
anova(fit.tst1, fit.tst1c)

fit.tst1 %>% 
  augment() %>% 
  clean_names() %>% 
  ggplot(aes(psg_tst, fitted, color = intensity))+
  geom_point(aes(y = watch_arou_rating),
             color = "grey", alpha = .3)+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)

fit.tst1 %>% r.squaredGLMM()
```


### Plot the models
```{r plot the models}
# plot the model prediction
p_tst_mod1 <- mod_tst4 %>% 
  augment()  %>% 
  clean_names() %>% 
  mutate(intensity = ifelse(intensity_num == 0, "neutral",
                            ifelse(intensity_num == 1, "low-negative",
                                   ifelse(intensity_num == 2, "mid-negative",
                                          "high-negative"))),
         intensity = factor(intensity, levels = c("neutral", "low-negative", 
                                                  "mid-negative", "high-negative"))) %>% 
  ggplot(aes(psg_tst, watch_val_rating, color = as.factor(intensity_num))) +
  # geom_point(alpha = .3, color = "grey")+
  geom_point(aes(y = fitted), alpha = .3)+
  geom_smooth(aes(y = fitted), method = "lm", se = F)+
  # facet_wrap(.~intensity, nrow = 1)+
  labs(#title = "a. PSG sleep duration and valence-reactivity",
       x = "total sleep time",
       y = "valence rating")+
  theme(legend.position = "none")

p_tst_mod2 <- mod_tst3 %>% 
  augment()  %>% 
  clean_names() %>% 
    mutate(intensity = ifelse(intensity_num == 0, "neutral",
                            ifelse(intensity_num == 1, "low-negative",
                                   ifelse(intensity_num == 2, "mid-negative",
                                          "high-negative"))),
         intensity = factor(intensity, levels = c("neutral", "low-negative", 
                                                  "mid-negative", "high-negative"))) %>% 
  ggplot(aes(psg_tst, watch_arou_rating, color = as.factor(intensity_num))) +
  # geom_point(alpha = .3, color = "grey")+
  geom_point(aes(y = fitted), alpha = .3)+
  geom_smooth(aes(y = fitted), method = "lm", se = F)+
  # facet_wrap(.~intensity, nrow = 1)+
  labs(#title = "b. PSG sleep duration and arousal-reactivity",
       x = "total sleep time",
       y = "arousal rating")+
  theme(legend.position = "none")

plot_grid(p_tst_mod1, p_tst_mod2, ncol = 1)
# ggsave("plots/tst-reactivity models_random_slope_facet.png", width = 9, height = 6)
ggsave("plots/tst-reactivity models_random_slope.png", width = 4, height = 6)


# plot the interaction the other way
ggplot(data = df.er_psg %>% filter(!is.na(psg_tst)),
       aes(intensity, watch_arou_rating, color = psg_tst)) +
  geom_point(alpha = .5, 
             position = position_jitter(width = .2))+
  scale_color_gradient2(midpoint= mean((df.er_psg %>% filter(!is.na(psg_tst)))$psg_tst), 
                       low="blue", mid="white",high="red", 
                       space ="Lab",
                       name = "sleep duration")
```

### add REM to the model
```{r REM and reactivity beyond TST}
# valence rating
lmerTest::lmer(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) +
                 scale(psg_rem)+
                 (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()


# arousal rating
lmerTest::lmer(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                 scale(psg_rem)+
                 (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()
```
### add SWS to the model
```{r SWS and reactivity beyond TST}
# valence rating
lmerTest::lmer(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) +
                 scale(psg_sws)+
                 (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()

# arousal rating
lmerTest::lmer(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                 scale(psg_sws)+
                 (1+scale(intensity_num)|participant),
               data = df.er_psg %>% filter(!is.na(psg_tst))) %>% summary()
```


## Bayesian models

We also built the same models using Bayesian package `brms` and compute the Bayes Factor for the effect of REM and SWS. First, we built the bayesian models with TST x intensity for both valence and arousal. The trace plots showed that the Monte Carlo sampling was effective.

### TST models (default priors)
```{r TST model using Bayesian brms}
# build mod_tst1 using brms (weakly-informative prior)
mod_tst1_brm <- brm(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "tst1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst1_brm %>% plot(N = 6)
# posterior_summary(mod_tst1_brm)[1:8,] %>% round(digits =  4)
print(mod_tst1_brm)
# bayes_R2(mod_tst1_brm)

# check the default prior
prior_summary(mod_tst1_brm)


# build mod_tst2 using brms (weakly-informative prior)
mod_tst2_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "tst2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst2_brm %>% plot(N = 6)
# posterior_summary(mod_tst2_brm)[1:8,] %>% round(digits =  4)
print(mod_tst2_brm)
# bayes_R2(mod_tst2_brm)

mod_tst2c_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)+scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "tst2c_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

# compare with the model with only intensity
bayes_factor(mod_tst2_brm, mod_tst2c_brm)
```
### add some priors
```{r add our own priors}
# get_prior(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
#                       (1+scale(intensity_num)|participant),
#           data = df.er_psg %>% filter(!is.na(psg_tst)))

mod_tst1_brm_prior <- brm(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
                      data = df.er_psg %>% filter(!is.na(psg_tst)),
                      prior = c(
                        prior(normal(0, 1), class = "b", coef = "scalepsg_tst"),
                        prior(normal(0, 1), class = "b", coef = "scaleintensity_num"),
                        prior(normal(0, 1), class = "b", coef = "scalepsg_tst:scaleintensity_num"),
                        # prior(lkj(1), class = "cor"),
                        prior(normal(0, 1), class = "Intercept"),
                        prior(cauchy(0, 1), class = "sd")
                      ),
                      family = gaussian,
               save_all_pars = T,
               file = "tst1_brm_prior",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst1_brm_prior %>% plot(N = 6)
# posterior_summary(mod_tst1_brm_prior)[1:8,] %>% round(digits =  4)
print(mod_tst1_brm_prior)

# check the default prior
prior_summary(mod_tst1_brm_prior)




mod_tst2_brm_prior <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
                      data = df.er_psg %>% filter(!is.na(psg_tst)),
                      prior = c(
                        prior(normal(0, 1), class = "b", coef = "scalepsg_tst"),
                        prior(normal(0, 1), class = "b", coef = "scaleintensity_num"),
                        prior(normal(0, 1), class = "b", coef = "scalepsg_tst:scaleintensity_num"),
                        # prior(lkj(1), class = "cor"),
                        prior(normal(0, 1), class = "Intercept"),
                        prior(cauchy(0, 1), class = "sd")
                      ),
                      family = gaussian,
               save_all_pars = T,
               file = "tst2_brm_prior",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
#mod_tst1_brm_prior %>% plot(N = 6)
# posterior_summary(mod_tst2_brm_prior)[1:8,] %>% round(digits =  4)
print(mod_tst2_brm_prior)

# check the default prior
prior_summary(mod_tst2_brm_prior)
```

### plot the models
```{r plot brm model predictions}
# calculate the mean and Sd for DVs
mean_watch_val = mean((df.er_psg %>% filter(!is.na(psg_tst)))$watch_val_rating)
sd_watch_val = sd((df.er_psg %>% filter(!is.na(psg_tst)))$watch_val_rating)
mean_watch_arou = mean((df.er_psg %>% filter(!is.na(psg_tst)))$watch_arou_rating)
sd_watch_arou = sd((df.er_psg %>% filter(!is.na(psg_tst)))$watch_arou_rating)


p_tst1_brm <- mod_tst1_brm %>% 
  fitted() %>% 
  data.frame() %>% 
  mutate(estimate_raw = Estimate*sd_watch_val + mean_watch_val) %>% 
  bind_cols(df.er_psg %>% filter(!is.na(psg_tst))) %>% 
  mutate(intensity = factor(intensity, levels = c("ntr", "low", "mid", "high"))) %>% 
  ggplot(aes(psg_tst, watch_val_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .5, color = "grey")+
  geom_point(aes(y = estimate_raw), alpha = .5)+
  geom_smooth(aes(y = estimate_raw), method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "brm prediction: TST and valence-reactivity",
       x = "total sleep time")+
  theme(legend.position = "none")


p_tst2_brm <- mod_tst1_brm %>% 
  fitted() %>% 
  data.frame() %>% 
  mutate(estimate_raw = Estimate*sd_watch_arou + mean_watch_arou) %>% 
  bind_cols(df.er_psg %>% filter(!is.na(psg_tst))) %>% 
  mutate(intensity = factor(intensity, levels = c("ntr", "low", "mid", "high"))) %>% 
  ggplot(aes(psg_tst, watch_arou_rating, color = as.factor(intensity_num))) +
  geom_point(alpha = .5, color = "grey")+
  geom_point(aes(y = estimate_raw), alpha = .5)+
  geom_smooth(aes(y = estimate_raw), method = "lm", se = F)+
  facet_wrap(.~intensity, nrow = 1)+
  labs(title = "brm prediction: TST and arousal-reactivity",
       x = "total sleep time")+
  theme(legend.position = "none")

plot_grid(p_tst1_brm, p_tst2_brm, ncol = 1)
# ggsave("plots/brm_models_tst.png", width = 9, height = 6)
```


Second, we built the bayesian models with TST x intensity plus REM duration for both valence and arousal. The trace plots showed that the Monte Carlo sampling was effective. Following that, we computed the Bayes Factor of the REM effect.

### add REM
```{r REM model using Bayesian brms}
# build mod_rem1 using brms (weakly-informative prior)
mod_rem1_brm <- brm(scale(watch_val_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      scale(psg_rem) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "rem1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# print the model results
print(mod_rem1_brm)
# the trace plots
# plot(mod_rem1_brm, N = 7)
# posterior_summary(mod_rem1_brm)[1:9,] %>% round(digits =  4)


# build mod_rem2 using brms (weakly-informative prior)
mod_rem2_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) + 
                      scale(psg_rem) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "rem2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# print the model results
print(mod_rem2_brm)
# the trace plot
# plot(mod_rem2_brm, N = 7)
# posterior_summary(mod_rem2_brm)[1:9,] %>% round(digits =  4)


# plot the posterior distribution of rem coefficient
p_rem1_brm <- mod_rem1_brm %>%
  posterior_samples() %>%
  select(starts_with("b_"), -contains("intercept")) %>%
  gather("predictor", "beta") %>%
  mutate(predictor = factor(predictor, 
                            levels = c("b_scalepsg_rem", 
                                       "b_scalepsg_tst:scaleintensity_num",
                                       "b_scalepsg_tst",
                                       "b_scaleintensity_num"),
                            labels = c("rem", "tst x intensity", 
                                       "tst", "intensity"))) %>% 
  ggplot(aes(y = predictor, x = beta))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  xlim(-.3, .8)+
  labs(title = "a. Valence: posterior distribution of betas")

p_rem2_brm <- mod_rem2_brm %>%
  posterior_samples() %>%
  select(starts_with("b_"), -contains("intercept")) %>%
  gather("predictor", "beta") %>%
  mutate(predictor = factor(predictor, 
                            levels = c("b_scalepsg_rem", 
                                       "b_scalepsg_tst:scaleintensity_num",
                                       "b_scalepsg_tst",
                                       "b_scaleintensity_num"),
                            labels = c("rem", "tst x intensity", 
                                       "tst", "intensity"))) %>% 
  ggplot(aes(y = predictor, x = beta))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  xlim(-.3, .8)+
  labs(title = "b. Arousal: posterior distribution of betas")

plot_grid(p_rem1_brm, p_rem2_brm, ncol = 1)
ggsave("plots/rem_posterior.png", width = 8, height = 6)
```

```{r Bayes factor: REM, message=F, results='hide'}
# compare the rem_model with the tst_model
# for valence
BF_rem1 = bayes_factor(mod_rem1_brm, mod_tst1_brm) # p(mod_rem1_brm)/p(mod_tst1_brm)
# for arousal
BF_rem2 = bayes_factor(mod_rem2_brm, mod_tst2_brm)

# bayes_factor uses the bridgesampling method (https://github.com/quentingronau/bridgesampling)

# print the BFs
BF_rem1
BF_rem2

```
```{r brm hypothesis: REM}
# hypothesis (look at Post.Prob and Evid.Ratio)
hypothesis(mod_rem1_brm,
           hypothesis = "abs(scalepsg_rem) > 0.1")
hypothesis(mod_rem2_brm,
           hypothesis = "abs(scalepsg_rem) > 0.1")

# # compare waic
# compare_ic(waic(mod_rem1_brm), waic(mod_tst1_brm))
# compare_ic(waic(mod_rem2_brm), waic(mod_tst2_brm))
```

For valence, the Bayes Factor of REM is `r BF_rem1[1] %>% as.numeric() %>% round(4)`. For arousal, the Bayes Factor of REM is `r BF_rem2[1] %>% as.numeric() %>% round(4)`. Both results provided evidence for a null effect of REM on emotional reactivity.

Third, we built the bayesian models with TST x intensity plus SWS duration for both valence and arousal. The trace plots showed that the Monte Carlo sampling was effective. Following that, we computed the Bayes Factor of the SWS effect.

### SWS model
```{r SWS model using Bayesian brms}
# build mod_sws1 using brms (weakly-informative prior)
mod_sws1_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                      scale(psg_sws) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "sws1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# # show the posterior
print(mod_sws1_brm)
# # the trace plots
# plot(mod_sws1_brm, N = 7)
# posterior_summary(mod_sws1_brm)[1:9,] %>% round(digits =  4)

# build mod_sws2 using brms (weakly-informative prior)
mod_sws2_brm <- brm(scale(watch_arou_rating) ~ scale(psg_tst)*scale(intensity_num) +
                      scale(psg_sws) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "sws2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)
# # print the model results
print(mod_sws2_brm)
# # the trace plot
# plot(mod_sws2_brm, N = 7)
# posterior_summary(mod_sws2_brm)[1:9,] %>% round(digits =  4)

# plot the posterior distribution of rem coefficient
p_sws1_brm <- mod_sws1_brm %>%
  posterior_samples() %>%
  select(starts_with("b_"), -contains("intercept")) %>%
  gather("predictor", "beta") %>%
  mutate(predictor = factor(predictor, 
                            levels = c("b_scalepsg_sws", 
                                       "b_scalepsg_tst:scaleintensity_num",
                                       "b_scalepsg_tst",
                                       "b_scaleintensity_num"),
                            labels = c("sws", "tst x intensity", 
                                       "tst", "intensity"))) %>% 
  ggplot(aes(y = predictor, x = beta))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  xlim(-.3, .8)+
  labs(title = "c. Valence: posterior distribution of betas")

p_sws2_brm <- mod_sws2_brm %>%
  posterior_samples() %>%
  select(starts_with("b_"), -contains("intercept")) %>%
  gather("predictor", "beta") %>%
  mutate(predictor = factor(predictor, 
                            levels = c("b_scalepsg_sws", 
                                       "b_scalepsg_tst:scaleintensity_num",
                                       "b_scalepsg_tst",
                                       "b_scaleintensity_num"),
                            labels = c("sws", "tst x intensity", 
                                       "tst", "intensity"))) %>% 
  ggplot(aes(y = predictor, x = beta))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  xlim(-.3, .8)+
  labs(title = "d. Arousal: posterior distribution of betas")

plot_grid(p_sws1_brm, p_sws2_brm, ncol = 1)
ggsave("plots/sws_posterior.png", width = 8, height = 6)


plot_grid(p_rem1_brm, p_rem2_brm, p_sws1_brm, p_sws2_brm, ncol = 1)
ggsave("plots/rem_sws_posterior.png", width = 8, height = 10)
```

```{r Bayes factor: SWS, message=F, results='hide'}
# compare the rem_model with the tst_model
# for valence
BF_sws1 = bayes_factor(mod_sws1_brm, mod_tst1_brm)
# for arousal
BF_sws2 = bayes_factor(mod_sws2_brm, mod_tst2_brm)

# print the BFs
BF_sws1
BF_sws2
```

```{r brm hypothesis: SWS}
# hypothesis (look at Post.Prob and Evid.Ratio)
hypothesis(mod_sws1_brm,
           hypothesis = "abs(scalepsg_sws) > 0.1") %>% print(digits = 4)
hypothesis(mod_sws2_brm,
           hypothesis = "abs(scalepsg_sws) > 0.1") %>% print(digits = 4)
```
For arousal, the Bayes Factor of SWS is `r BF_sws1[1] %>% as.numeric() %>% round(4)`. For arousal, the Bayes Factor of SWS is `r BF_sws2[1] %>% as.numeric() %>% round(4)`. Both results provided evidence for a null effect of SWS on emotional reactivity.

Finally, we built the bayesian models for understanding the effects of all sleep stages at the same time. All variables are standardized before fitting the model so that the parameter posteriors are in the same scale. The trace plots showed that the Monte Carlo sampling was effective. The model results are presented in the following tables.

### model with all 4 stages
```{r sleep stages model using Bayesian brms, warning=F}
# build mod_sleep1 using brms
mod_sleep1_brm = brm(scale(watch_val_rating)~scale(psg_n1)+scale(psg_n2)+
                       scale(psg_sws)+scale(psg_rem)+
                       scale(intensity_num) + 
                       (1+intensity_num|participant),
                     data = df.er_psg %>% filter(!is.na(psg_tst)),
                     family = gaussian,
                     file = "sleep1_brm",
                     iter = 2000, warmup = 500, chains = 4, cores = 2)

mod_sleep1_brm_new = brm(scale(watch_val_rating)~scale(psg_n1)+scale(psg_n2)+
                           scale(psg_sws)+scale(psg_rem)+
                           scale(intensity_num) + 
                           scale(intensity_num):scale(psg_tst)+
                           (1+intensity_num|participant),
                         data = df.er_psg %>% filter(!is.na(psg_tst)),
                         family = gaussian,
                         file = "sleep1_brm_new",
                         iter = 2000, warmup = 500, chains = 4, cores = 2)

# plot(mod_sleep1_brm, N = 8)
# posterior_summary(mod_sleep1_brm_new)[1:7,] %>% round(digits =  4)

# build mod_sleep2 using brms
mod_sleep2_brm = brm(scale(watch_arou_rating) ~ ~scale(psg_n1)+scale(psg_n2)+
                       scale(psg_sws)+scale(psg_rem)+
                       scale(intensity_num)+
                       (1+intensity_num|participant),
                     data = df.er_psg %>% filter(!is.na(psg_tst)),
                     family = gaussian,
                     file = "sleep2_brm",
                     iter = 2000, warmup = 500, chains = 4, cores = 2)

mod_sleep2_brm_new = brm(scale(watch_arou_rating)~scale(psg_n1)+scale(psg_n2)+
                           scale(psg_sws)+scale(psg_rem)+
                           scale(intensity_num) + 
                           scale(intensity_num):scale(psg_tst)+
                           (1+intensity_num|participant),
                         data = df.er_psg %>% filter(!is.na(psg_tst)),
                         family = gaussian,
                         file = "sleep2_brm_new",
                         iter = 2000, warmup = 500, chains = 4, cores = 2)

# plot(mod_sleep2_brm_new, N = 8)
# print(mod_sleep2_brm_new)
# posterior_summary(mod_sleep2_brm_new)[1:7,] %>% round(digits =  4)

hypothesis(mod_sleep2_brm_new, hypothesis = "scalepsg_rem > 0")
```

The posterior distributions of the effects of each sleep stage on valence and arousal are presented in the figure below. Consistent with the results of the non-Bayesian models, Stage 2 sleep seemed to have the largest effect on emotional ractivity among all sleep stages.
```{r visualize the posterior of sleep stages, warning=F}
# plot the standardized b for each predictor
p_sleep1_brm <- mod_sleep1_brm_new %>%
  posterior_samples() %>%
  select(starts_with("b_scale")) %>%
  gather("variable", "value") %>%
  ggplot(aes(y = variable, x = value))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  #geom_vline(xintercept = c(-.1, .1), linetype = 2, color = "blue")+
  labs(title = "Model on valence")


# plot the standardized b for each predictor
p_sleep2_brm <- mod_sleep2_brm_new %>%
  posterior_samples() %>%
  select(starts_with("b_scale")) %>%
  gather("variable", "value") %>%
  ggplot(aes(y = variable, x = value))+
  tidybayes::geom_halfeyeh()+
  geom_vline(xintercept = 0, linetype = 2)+
  #geom_vline(xintercept = c(-.1, .1), linetype = 2, color = "blue")+
  labs(title = "Model on arousal")

plot_grid(p_sleep1_brm, p_sleep2_brm, ncol = 1)
# ggsave("../../figures/sleep_stages_posterior.png", width = 8, height = 10)
```

## Trait-level information (individual difference questionnaires)

```{r read individual difference data}
# read individual difference data
df.ind_diff <- read_csv(paste("Z:/SBER/SBER1_physio_R56/data/Full_Study/inddiff_Qualtrics/", 
                        "processed/FinalDATA104.csv", sep = ""))

# score pers and psqi
df.ind_diff <- df.ind_diff %>% 
  mutate(pers_apr = pers_gpr/15, pers_anr = pers_gnr/15)%>% 
  mutate(psqi_c1 = psqi9,
         psqi_ssq = 3- psqi_c1, # subjective sleep quality recoded
         # c1: subjective sleep quality
         psqi_lat = ifelse(minutestosleep_Minute <= 15, 0, 
                          ifelse(minutestosleep_Minute >= 16 & 
                                   minutestosleep_Minute <= 30, 1,
                                 ifelse(minutestosleep_Minute <= 60 &
                                          minutestosleep_Minute >= 31, 2,
                                        ifelse(minutestosleep_Minute > 60, 3, 999)))),
         psqi_c2 = (psqi_lat + psqi5a + 1) %/% 2,
         # c2: sleep latency
         psqi_sd = hourssleep_Hours,
         psqi_c3 = ifelse(psqi_sd > 7, 0,
                          ifelse(psqi_sd %in% c(6,7), 1,
                                 ifelse(psqi_sd %in% c(5,6), 2,
                                        ifelse(psqi_sd < 5, 3, 999)))),
         # c3: sleep duration
         psqi_tib = (timeoutbed_Hour - timetobed_Hour) +
           (timeoutbed_Minute - timetobed_Minute)/60,
         psqi_tib = ifelse(psqi_tib < 0, psqi_tib + 12, psqi_tib),
         psqi_se = psqi_sd/psqi_tib,
         psqi_se = ifelse(psqi_se > 1, 1, psqi_se),
         psqi_c4 = ifelse(psqi_se >= .85, 0,
                          ifelse(psqi_se >= .75 & psqi_se < .85, 1, 
                          ifelse(psqi_se >= .65 & psqi_se < .75, 2,
                                 ifelse(psqi_se < .65, 3, 999)))),
         # c4: sleep efficiency
         psqi_slp_distb = psqi5a +  psqi5b +  as.numeric(psqi5c) +  psqi5d +  psqi5e + 
            psqi5f +  psqi5g +  psqi5h +  psqi5i +  
           ifelse(psqi5j == "#NULL!", 0, as.numeric(psqi5j)),
         psqi_c5 = ifelse(psqi_slp_distb == 0, 0,
                          ifelse(psqi_slp_distb <= 9 & psqi_slp_distb >= 1, 1,
                                 ifelse(psqi_slp_distb <= 18 & psqi_slp_distb >= 10, 2,
                                        ifelse(psqi_slp_distb <= 27 & 
                                                 psqi_slp_distb >= 19, 3, 999)))),
         # c5: sleep disturbance
         psqi_c6 = psqi6,
         # c6; use of sleep medication
         psqi_c7 = (psqi7 + psqi8 + 1) %/% 2,
         # c7: daytime dysfunction
         psqi_global = psqi_c1 + psqi_c2 + psqi_c3 + psqi_c4 + 
           psqi_c5 +psqi_c6 + psqi_c7,
         # global: sum of 7 components - the global score
         psqi_score_diff = psqi_total - psqi_global
         ) 

```

```{r read sleep diary data}
# read individual difference data
df.diary <- read_csv("Z:/SBER/SBER1_physio_R56/data/Full_Study/diary_Qualtrics/processed/processed_ready_for_analysis/diary_pmam_joined.csv") %>% 
  mutate(participant = as.character(ID)) %>% 
  filter(! participant %in% c("1001", "1002")) # exclude pilot data

df.diary %>% glimpse()

df.diary_ind <- df.diary %>% 
  select(participant, StartDate_PM, StartDate_PM_PST, 
         emoarousaltoday_PM, negativetoday_PM,
         self_tst, totalsleeptime_AM, Sleep_Efficiency, 
         subjsleepquality_AM_intgr, satisfiedsleep_AM) %>%
  rename(startdate_am = StartDate_PM, startdate_pm = StartDate_PM_PST) %>% 
  filter(totalsleeptime_AM >= 120) %>% 
  group_by(participant) %>% 
  summarise(startdate_diary = startdate_pm[1],
            enddate_diary = startdate_am[n()],
            diary_count = n(),
            emoarousaltoday_diary = mean(emoarousaltoday_PM, na.rm = T),
            negativetoday_diary = mean(negativetoday_PM, na.rm = T),
            totalsleeptime_diary = mean(totalsleeptime_AM, na.rm = T),
            sleep_efficiency_diary = mean(Sleep_Efficiency, na.rm = T),
            subjsleepquality_diary = mean(subjsleepquality_AM_intgr, na.rm = T),
            satisfiedsleep_diary = mean(satisfiedsleep_AM, na.rm = T)) %>% 
  filter(diary_count >= 10) %>% # exclude cases who had insufficient days
  mutate(startdate_diary = str_c('20', str_sub(startdate_diary, 3, -1)),
         enddate_diary = str_c('20', str_sub(enddate_diary, 3, -1))) # fix the year format

```


```{r construct ind-level data for reactivity analysis}
df.all_reactivity <- df.er_physio_neg_reactivity %>%
  left_join(df.er_psg %>% 
              filter(intensity == "high") %>% 
              select(participant, age, gender, starts_with("psg_")),
            by = c("participant"))  %>% 
  left_join(df.ind_diff %>% 
              select(EndDate, partID, starts_with("psqi_"), starts_with("pers_")) %>% 
              rename(enddate_inddiff = EndDate),
            by = c("participant" = "partID")) %>% 
  left_join(df.diary_ind, by = "participant") %>% 
  filter(! participant %in% c("1001", "1002")) # exclude pilot data
  

#add date information
df.er_date <- read_csv("Z:/SBER/SBER1_physio_R56/data/Full_Study/session2_data/ier/IER_trial_level.csv") %>% 
  select(participant, date) %>% 
  mutate(participant = as.character(participant)) %>% 
  group_by(participant) %>% 
  summarise(date_er_task = date[1])

df.psg_date <- read_csv("Z:/SBER/SBER1_physio_R56/data/Full_Study/redcap/Biocalibration_DATA_2019-03-08_0956.csv") %>% 
  filter(!participant_id %in% c("3694", "5811")) %>%   # remove the first log of 3694 and 5811  (they have a 2nd psg) 
  mutate(pid = str_sub(participant_id, 1, 4),
         pid = ifelse(is.na(as.numeric(subject_id)), pid,
           ifelse(as.numeric(subject_id) > as.numeric(pid), subject_id, pid))) %>% 
  rename(participant = pid, date_psg = date_of_visit) %>% 
  select(participant, date_psg) %>% 
  group_by(participant) %>% 
  filter(row_number() == n()) %>% 
  ungroup()

df.all_reactivity <- df.all_reactivity %>% 
  left_join(df.er_date, by = "participant") %>% 
  left_join(df.psg_date, by = "participant")

# write the data for reactivity analysis to the server
write_csv(df.all_reactivity,
          "Z:/SBER/SBER1_physio_R56/data/Full_Study/session2_data/ier/data_all_for_reactivity_participant_level.csv")

df.all_reactivity <- read_csv("Z:/SBER/SBER1_physio_R56/data/Full_Study/session2_data/ier/data_all_for_reactivity_participant_level.csv") %>% 
  mutate(participant = as.character(participant))

```


```{r time gap between measurements}
date_inddiff = df.all_reactivity$enddate_inddiff %>% strptime("%m/%d/%y")
date_psg = df.all_reactivity$date_psg %>% strptime("%Y-%m-%d")
date_diary_start = df.all_reactivity$startdate_diary %>% strptime("%Y-%m-%d")
date_diary_end = df.all_reactivity$enddate_diary %>% strptime("%Y-%m-%d")
date_er = df.all_reactivity$date_er_task %>% strptime("%Y_%b_%d")

difftime(date_psg, date_inddiff, units = "days") %>% as.numeric() %>% hist()
difftime(date_diary_start, date_inddiff, units = "days")
difftime(date_diary_end, date_psg, units = "days")
difftime(date_er, date_psg, units = "days") 
difftime(date_er, date_inddiff, units = "days") %>% as.numeric() %>% mean(na.rm = T)
```


```{r pers and psqi}
## add psqi and pers to the data
df.er_psg <- df.er_psg %>% 
  left_join(df.ind_diff %>% 
              select(partID, starts_with("psqi_"), starts_with("pers_")),
            by = c("participant" = "partID"))

# fyp final sample
psych::corr.test(df.er_psg %>%
                   filter(intensity == "high", 
                          psqi_sd > 4,
                          !is.na(df.er_psg$psg_tst)) %>%
                   select(pers_anr, pers_apr, psqi_sd, psqi_c1, psqi_se,psqi_lat))
cor.test(df.er_psg$pers_apr[df.er_psg$intensity=="high" &
                              !is.na(df.er_psg$psg_tst)],
         df.er_psg$psqi_sd[df.er_psg$intensity=="high" &
                                      !is.na(df.er_psg$psg_tst)])


# R56 final sample
# cor.test(df.ind_diff$pers_anr, df.ind_diff$psqi_sd)
# psych::corr.test(df.ind_diff %>%
#                    select(pers_anr, psqi_sd, psqi_c1, psqi_se, psqi_c4, psqi_lat, psqi_c2))


# scatter plots
p_psqi_pers1 <- ggplot(df.er_psg %>% filter(intensity == "high", 
                                            !is.na(psg_tst),
                                            psqi_sd > 4),
       aes(psqi_sd, pers_anr))+
  geom_point(alpha = .5, position = position_jitter(width = .2))+
  geom_smooth(method = "lm")+
  labs(#title = "b",
       x = "PSQI sleep duration",
       y = "PERS negative reactivity")
# ggsave("plots/psqi_pers_neg.png", width = 4, height = 3)

p_psqi_pers2 <-ggplot(df.er_psg %>% filter(intensity == "high", 
                                           !is.na(psg_tst),
                                            psqi_sd > 4),
       aes(psqi_sd, pers_apr))+
  geom_point(alpha = .5, position = position_jitter(width = .2))+
  geom_smooth(method = "lm")+
  labs(# title = "a",
       x = "PSQI sleep duration",
       y = "PERS positive reactivity")

plot_grid(p_psqi_pers2, p_psqi_pers1, labels = c("a", "b"))
ggsave("plots/psqi_pers.png", width = 8, height = 4)

```
```{r visualization: habitual sleep and reactivity}
df.er_psg_diary$intensity_num <- factor(df.er_psg_diary$intensity_num,
                                        labels = c("neutral", "low-negative",
                                                   "mid-negative", "high-negative"))

p_psqi_tst1 <- ggplot(df.er_psg_diary %>% filter(!is.na(psg_tst)), 
       aes(psqi_sleep_hours, watch_val_rating, 
           color = intensity_num)) +
  geom_point(alpha = .3, position = position_jitter(width = .2))+
  geom_smooth(method = "lm", se = T)+
  facet_wrap(.~intensity_num, nrow = 1)+
  labs(title = "a. PSQI sleep and valence-reactivity",
    x = "PSQI sleep duration",
    y = "valence rating",
    color = "Intensity")+
  theme(legend.position = "none")

p_psqi_tst2 <- ggplot(df.er_psg_diary %>% filter(!is.na(psg_tst)), 
       aes(psqi_sleep_hours, watch_arou_rating, 
           color = intensity_num)) +
  geom_point(alpha = .3, position = position_jitter(width = .2))+
  geom_smooth(method = "lm", se = T)+
  facet_wrap(.~intensity_num, nrow = 1)+
  labs(title = "b. PSQI sleep and arousal-reactivity",
       x = "PSQI sleep duration",
       y = "arousal rating",
    color = "Intensity")+
  theme(legend.position = "none")

plot_grid(p_psqi_tst1, p_psqi_tst2, ncol = 1)
# ggsave("plots/psqi_tst_reactivity.png", width = 5.5, height = 6)
ggsave("plots/psqi_tst_reactivity_facet.png", width = 9, height = 6)
```


```{r lmer: habitual sleep and reactivity}
# psqi sleep
lmerTest::lmer(scale(watch_val_rating) ~ scale(psqi_sd)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% 
                 filter(!is.na(df.er_psg$psg_tst), psqi_sd> 4)) %>% 
  summary()


lmerTest::lmer(scale(watch_arou_rating) ~ scale(psqi_sd)*scale(intensity_num) +
                   (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% 
                 filter(!is.na(df.er_psg$psg_tst), psqi_sd> 4)) %>% 
  summary()


# correlations
df.er_psg %>% 
  filter(!is.na(df.er_psg$psg_tst), psqi_sd> 4) %>% 
  select(participant, intensity, psqi_sd, watch_val_rating, watch_arou_rating) %>% 
  gather(type, rating, starts_with("watch")) %>%
  mutate(type = str_c(type, intensity, sep = "_")) %>% 
  select(-intensity) %>% 
  spread(type, rating) %>% 
  select(-participant) %>% 
  psych::corr.test()

```

```{r brm: habitual sleep and reactivity}
# psqi sleep
## valence
mod_psqi1_brm <- brm(scale(watch_val_rating) ~ scale(psqi_sd)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "psqi1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

mod_intensity1_brm <- brm(scale(watch_val_rating) ~ scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "intensity1_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

bayes_factor(mod_psqi1_brm, mod_intensity1_brm)

## arousal
mod_psqi2_brm <- brm(scale(watch_arou_rating) ~ scale(psqi_sd)*scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "psqi2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

mod_intensity2_brm <- brm(scale(watch_arou_rating) ~ scale(intensity_num) + 
                      (1+scale(intensity_num)|participant), 
               data = df.er_psg %>% filter(!is.na(psg_tst)),
               family = gaussian,
               save_all_pars = T,
               file = "intensity2_brm",
               iter = 2000, warmup = 500, chains = 4, cores = 2)

bayes_factor(mod_psqi2_brm, mod_intensity2_brm)
```

```{r pers and ER reactivity}
df.er_psg$intensity = factor(df.er_psg$intensity, levels = c("ntr", "low", "mid", "high"))

p_pers1 <- ggplot(df.er_psg,
       aes(pers_anr, watch_val_rating, color = intensity_num))+
  geom_point(alpha = .3)+
  geom_smooth(method = "lm")+
  # facet_wrap(.~intensity, nrow = 1)+
  labs(#title = "PERS negative reactivity and valence-reactivity",
       color = "intentisity")

p_pers2 <- ggplot(df.er_psg,
       aes(pers_anr, watch_arou_rating, color = intensity_num))+
  geom_point(alpha = .3)+
  geom_smooth(method = "lm")+
  # facet_wrap(.~intensity, nrow = 1)+
  labs(#title = "PERS negative reactivity and arousal-reactivity",
       color = "intentisity")

plot_grid(p_pers1, p_pers2, ncol = 1)
ggsave("plots/pers_task_reactivity.png", width = 5.5, height = 6)

# correlation between pers and valence rating (neg pictures)
# cor.test(df.er_psg$pers_anr[df.er_psg$intensity!="ntr" & !is.na(df.er_psg$psg_tst)],
#          df.er_psg$watch_val_rating[df.er_psg$intensity!="ntr" & !is.na(df.er_psg$psg_tst)])
# # correlation between pers and arousal rating (neg pictures)
# cor.test(df.er_psg$pers_anr[df.er_psg$intensity!="ntr" & !is.na(df.er_psg$psg_tst)],
#          df.er_psg$watch_arou_rating[df.er_psg$intensity!="ntr" & !is.na(df.er_psg$psg_tst)])

df.er_psg_neg <- df.er_psg %>% 
  filter(intensity != "ntr", 
         #intensity %in% c("high", "mid"),
         !is.na(df.er_psg$psg_tst)) %>% 
  group_by(participant) %>% 
  summarise(pers_anr = mean(pers_anr),
            watch_val_rating = mean(watch_val_rating),
            watch_arou_rating = mean(watch_arou_rating),
            psg_tst = mean(psg_tst),
            psqi_sd = mean(psqi_sd))

cor.test(df.er_psg_neg$pers_anr, df.er_psg_neg$watch_val_rating)
cor.test(df.er_psg_neg$pers_anr, df.er_psg_neg$watch_arou_rating)
```

```{r plot negative trials}
ggplot(df.er_psg_neg,
       aes(psg_tst, watch_arou_rating))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm")+
  ylim(1, 5)+
  # annotate("text", x = 1.2, y = 550, label = "r = -.03", 
  #          color = "blue", size = 6)+
  labs(#title = "PERS negative reactivity and PSG TST",
       y = "Arousal rating",
       x = "PSG sleep duration")
ggsave("plots/tst-reactivity_neg.png", width = 4, height = 3)

ggplot(df.er_psg_neg,
       aes(pers_anr, watch_arou_rating))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm")+
  ylim(1, 5)+
  # annotate("text", x = 1.2, y = 550, label = "r = -.03", 
  #          color = "blue", size = 6)+
  labs(#title = "PERS negative reactivity and PSG TST",
       y = "Arousal rating",
       x = "PERS negative reactivity")
ggsave("plots/pers-reactivity_neg.png", width = 4, height = 3)


ggplot(df.er_psg_neg,
       aes(psqi_sd, watch_arou_rating))+
  geom_point(alpha = .5, position = position_jitter(width = .2))+
  geom_smooth(method = "lm")+
  ylim(1, 5)+ xlim(5., 9)+
  # annotate("text", x = 1.2, y = 550, label = "r = -.03", 
  #          color = "blue", size = 6)+
  labs(#title = "PERS negative reactivity and PSG TST",
       y = "Arousal rating",
       x = "PSQI sleep duration")
ggsave("plots/psqi-reactivity_neg.png", width = 4, height = 3)

cor.test(df.er_psg_neg$psg_tst, df.er_psg_neg$watch_arou_rating)
cor.test(df.er_psg_neg$watch_val_rating, df.er_psg_neg$watch_arou_rating)
cor.test(df.er_psg_neg$psqi_sd, df.er_psg_neg$watch_arou_rating)
cor.test(df.er_psg_neg$psg_tst, df.er_psg_neg$pers_anr)
cor.test(df.er_psg_neg$psqi_sd, df.er_psg_neg$pers_anr)
```


```{r psqi and psg sleep}
# correlation
ggplot(df.er_psg %>% filter(intensity=="high", psqi_sd > 4),
       aes(psqi_sd, psg_tst))+
  geom_point(alpha = .5, position = position_jitter(width = .2))+
  geom_smooth(method = "lm")+
  # annotate("text", x = 1.2, y = 550, label = "r = -.03", 
  #          color = "blue", size = 6)+
  labs(#title = "PERS negative reactivity and PSG TST",
       x = "PSQI sleep duration",
       y = "PSG sleep duration")

ggsave("plots/psqi_psg_tst.png", width = 4, height = 3)

# correlation
cor.test(df.er_psg$psqi_sd[df.er_psg$intensity=="high" &
                              !is.na(df.er_psg$psg_tst)],
         df.er_psg$psg_tst[df.er_psg$intensity=="high" &
                                      !is.na(df.er_psg$psg_tst)])
```

```{r psg sleep and pers}
# correlation
ggplot(df.er_psg %>% filter(intensity=="high", psqi_sd > 4),
       aes(psg_tst, pers_anr))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm")+
  # annotate("text", x = 1.2, y = 550, label = "r = -.03", 
  #          color = "blue", size = 6)+
  labs(#title = "PERS negative reactivity and PSG TST",
       x = "PSG sleep duration",
       y = "PERS negative reactivity")

ggsave("plots/tst-pers_neg.png", width = 4, height = 3)


cor.test(df.er_psg$pers_anr[df.er_psg$intensity=="high" &
                              !is.na(df.er_psg$psg_tst)],
         df.er_psg$psg_tst[df.er_psg$intensity=="high" &
                                      !is.na(df.er_psg$psg_tst)])


```


```{r sleep and EMG reactivity}
df.emg_sleep_corr <- data.frame(
  participant = rep(df.all_reactivity$participant, 3),
  reactivity = rep(df.all_reactivity$emg_corr_change_watch, 3),
  sleep = c(df.all_reactivity$psqi_ssq,
            df.all_reactivity$psqi_sd,
            df.all_reactivity$psg_tst),
  sleep_measure = rep(c("Subj slp quality", 
                        "Subj slp duration", 
                        "PSG slp duration"),
                   each = 80)) %>% 
  mutate(sleep_measure = factor(sleep_measure, 
                                levels = c("Subj slp quality", 
                                           "Subj slp duration", 
                                           "PSG slp duration")))

tb.emg_sleep_corr <- df.emg_sleep_corr %>% group_by(sleep_measure) %>% 
  summarise(correlation = cor(sleep,
                           reactivity, 
                           use = "na.or.complete"))

ggplot(df.emg_sleep_corr, aes(sleep, reactivity, color = sleep_measure))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F)+
  geom_text(data = tb.emg_sleep_corr,
            color = "black",
            aes(x = c(1, 4, 5), y = 0.8,
                label = sprintf("r=%0.2f", correlation)),
            hjust = 0, vjust = 0)+
  facet_wrap(.~sleep_measure, scales = "free")+
  labs(y = "Corrugator EMG reactivity", x = "Sleep")+
  theme(legend.position = "none")

```

```{r sleep and EDA reactivity}
df.eda_sleep_corr <- data.frame(
  participant = rep(df.all_reactivity$participant, 3),
  reactivity = rep(df.all_reactivity$scl_change_pic_watch, 3),
  scl_baseline_watch = rep(df.all_reactivity$scl_baseline_watch, 3),
  sleep = c(df.all_reactivity$psqi_ssq,
            df.all_reactivity$psqi_sd,
            df.all_reactivity$psg_tst),
  sleep_measure = rep(c("Subj slp quality", 
                        "Subj slp duration", 
                        "PSG slp duration"),
                   each = 80)) %>% 
  mutate(sleep_measure = factor(sleep_measure, 
                                levels = c("Subj slp quality", 
                                           "Subj slp duration", 
                                           "PSG slp duration")))

tb.eda_sleep_corr <- df.eda_sleep_corr %>% group_by(sleep_measure) %>% 
  summarise(correlation = cor(sleep,
                              # scl_baseline_watch,
                           reactivity, 
                           use = "na.or.complete"))

ggplot(df.eda_sleep_corr, aes(sleep, reactivity, color = sleep_measure))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F)+
  geom_text(data = tb.eda_sleep_corr,
            color = "black",
            aes(x = c(1, 4, 5), y = 0.1,
                label = sprintf("r=%0.2f", correlation)),
            hjust = 0, vjust = 0)+
  facet_wrap(.~sleep_measure, scales = "free")+
  labs(y = "SCL-change reactivity", x = "Sleep")+
  theme(legend.position = "none")


```
```{r all sleep and reactivity}
df.reactivity_sleep_corr <- data.frame(
  participant = rep(df.all_reactivity$participant, 12),
  reactivity = c(rep(df.all_reactivity$emg_corr_change_watch, 3),
                 rep(df.all_reactivity$scl_change_pic_watch, 3),
                 rep(df.all_reactivity$watch_arou_rating, 3),
                 rep(df.all_reactivity$pers_anr, 3)),
  sleep = rep(c(df.all_reactivity$psqi_ssq,
                df.all_reactivity$psqi_sd,
                df.all_reactivity$psg_tst), 4),
  reactivity_measure = rep(c("Corrugator EMG change", 
                             "SCL change", 
                             "Arousal rating",
                             "PERS negative reactivity"),
                           each = 240),
  sleep_measure = rep(rep(c("Subj slp quality", 
                            "Subj slp duration", 
                            "PSG slp duration"),
                          each = 80), 4)) %>% 
  mutate(reactivity_measure = factor(reactivity_measure, 
                                     levels = c( "PERS negative reactivity",
                                                 "Arousal rating",
                                                 "Corrugator EMG change", 
                                                 "SCL change")),
         sleep_measure = factor(sleep_measure, 
                                levels = c("Subj slp quality", 
                                           "Subj slp duration", 
                                           "PSG slp duration")))

# generate the correlation table
tb.reactivity_sleep_corr <- df.reactivity_sleep_corr %>% 
  group_by(reactivity_measure, sleep_measure) %>% 
  summarise(correlation = cor(sleep,
                           reactivity, 
                           use = "na.or.complete"))


ggplot(df.reactivity_sleep_corr, aes(sleep, reactivity, color = sleep_measure))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F)+
  geom_text(data = tb.reactivity_sleep_corr,
            color = "black",
            aes(x = rep(c(0.1,4,5),4), y = rep(c(4.1,4,.7,.1), each = 3),
                label = sprintf("r=%0.2f", correlation)),
            hjust = 0, vjust = 0)+
  facet_grid(reactivity_measure ~ sleep_measure , scales = "free")+
  labs(y = "Reactivity", x = "Sleep")+
  theme(legend.position = "none")

ggplot(df.reactivity_sleep_corr %>% 
         filter(reactivity_measure != "Corrugator EMG change"), 
       aes(sleep, reactivity, color = sleep_measure))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm", se = F)+
  geom_text(data = tb.reactivity_sleep_corr %>% 
         filter(reactivity_measure != "Corrugator EMG change"),
            color = "black",
            aes(x = rep(c(0.1,4,5),3), y = rep(c(4.1,4,.1), each = 3),
                label = sprintf("r=%0.2f", correlation)),
            hjust = 0, vjust = 0)+
  facet_grid(reactivity_measure ~ sleep_measure , scales = "free")+
  labs(y = "Reactivity", x = "Sleep")+
  theme(legend.position = "none")

ggsave("plots/sleep_reactivity_all_measures2.png", width = 6, height = 6)
```



## generating (fake) hypothesis data
```{r}
sleep = rnorm(70, 7, 1)
reactivity_neg = -.25*(sleep - 7) + rnorm(70, 3, .6)
reactivity_pos = .25*(sleep - 7) + rnorm(70, 3, .6)
reactivity_nul = 0*(sleep - 7) + rnorm(70, 3, .6)

df.fake_neg <- data.frame(sleep, reactivity_neg)
df.fake_pos <- data.frame(sleep, reactivity_pos)
df.fake_nul <- data.frame(sleep, reactivity_nul)

ggplot(df.fake_pos, aes(sleep, reactivity_pos))+
  geom_point(alpha = .5)+
  geom_smooth(method = "lm")+
  xlim(5, 9) + ylim(1, 5)+
  labs(title = "", x = "sleep", y = "reactivity")+
  theme_classic()+
  theme(text = element_text(size = 14))

ggsave("plots/fake_pos.png", width = 4, height = 3)
```


## Session information
```{r session_info}
sessionInfo()
```

## Save the workspace
```{r save workspace, eval=F}
save.image('data/workspace_fyp_study2.Rdata')
```
